<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <!-- เพิ่ม viewport-fit=cover เพื่อรองรับหน้าจอไร้ขอบ -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>SmartBooking - ระบบจองใช้งานทรัพยากร</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- QR Code Scanner Library -->
    <script src="https://unpkg.com/html5-qrcode"></script>
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=Prompt:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['Inter', 'Prompt', 'sans-serif'] },
                    animation: {
                        'float-hint': 'floatHint 2s ease-in-out infinite',
                        'fade-in-up': 'fadeInUp 0.5s ease-out forwards',
                        'bounce-slow': 'bounce 2s infinite',
                    },
                    keyframes: {
                        floatHint: {
                            '0%, 100%': { transform: 'translateY(0)' },
                            '50%': { transform: 'translateY(-5px)' },
                        },
                        fadeInUp: {
                            '0%': { opacity: '0', transform: 'translateY(10px)' },
                            '100%': { opacity: '1', transform: 'translateY(0)' },
                        }
                    }
                }
            }
        }
    </script>

    <style>
        /* Fix for Safari Mobile Height Issues */
        body { 
            font-family: 'Prompt', sans-serif; 
            overflow: hidden; 
            height: 100vh; /* Fallback */
            height: 100dvh; /* Dynamic Viewport Height for Mobile Browsers */
            background-color: #f8fafc; 
            margin: 0; 
            padding: 0; 
        }
        
        #app { 
            height: 100vh; /* Fallback */
            height: 100dvh; /* Dynamic Viewport Height */
            display: flex; 
            flex-direction: column; 
            position: relative; 
            /* Ensure background covers sticky overscrolls */
            background-color: #f8fafc;
        }
        
        .scrollable-content {
            flex: 1;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
            padding-bottom: calc(160px + env(safe-area-inset-bottom)); /* Add safe area spacing */
            position: relative;
            scroll-behavior: smooth; /* Smooth scrolling for the button action */
        }

        /* Safe Area Padding Utilities */
        .safe-pt { padding-top: env(safe-area-inset-top); }
        .safe-pb { padding-bottom: env(safe-area-inset-bottom); }

        @keyframes scan-line {
            0% { top: 10%; }
            100% { top: 90%; }
        }
        .animate-scan-line { animation: scan-line 2s linear infinite; }
        
        #reader { width: 100% !important; border: none !important; position: relative; aspect-ratio: 1/1; overflow: hidden; background: #000; }
        #reader video { border-radius: 2rem; object-fit: cover !important; width: 100% !important; height: 100% !important; }
        
        .ticket-cutout {
            background-image: radial-gradient(circle at 0 50%, transparent 10px, white 11px), 
                              radial-gradient(circle at 100% 50%, transparent 10px, white 11px);
        }
        
        .custom-scrollbar::-webkit-scrollbar { width: 4px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }

        /* Disable page transition animation to reduce visual jumping when state updates frequently */
        .page-transition { animation: fadeIn 0.2s ease-out; }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(4px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 4px;
        }
        
        /* Utility to force hide scrollbar but keep functionality if needed */
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
    </style>
</head>
<body class="text-slate-900">

    <div id="app">
        <div class="flex items-center justify-center h-full text-indigo-600">
            <div class="animate-spin rounded-full h-10 w-10 border-t-2 border-indigo-600 border-opacity-30"></div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, collection, onSnapshot, setDoc, addDoc, updateDoc, deleteDoc, serverTimestamp, runTransaction } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAYWIoMwtHmhhcEGloHX2pjX_wmv9Wj-O0",
            authDomain: "picture-30ba8.firebaseapp.com",
            databaseURL: "https://picture-30ba8-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "picture-30ba8",
            storageBucket: "picture-30ba8.firebasestorage.app",
            messagingSenderId: "486821075004",
            appId: "1:486821075004:web:ac910ff60949174c090b39",
            measurementId: "G-W0KL32TSHM"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const fbId = "smart-booking-v4"; 

        // --- NEW: Student Database Mapping (Fallback) ---
        // This is kept for backup, but the system will prefer the Whitelist data if available
        const STUDENT_DATABASE = {
            "65030298": "นายนราวิชญ์ สมันตกล"
        };

        // --- UPDATED: Get Display Name Logic ---
        function getDisplayName(id) {
            if (!id) return "-";
            if (id === "ADMIN") return "Admin";
            
            // 1. Try to find in dynamic whitelist (allowedStudents) FIRST
            // Searches for any line starting with the ID
            let fullName = null;
            if (window.state && window.state.allowedStudents) {
                const foundEntry = window.state.allowedStudents.find(entry => entry.startsWith(id));
                if (foundEntry) {
                    // Extract Name: Find first whitespace and take everything after
                    const firstSpaceIndex = foundEntry.search(/[\s\t]/);
                    if (firstSpaceIndex !== -1) {
                        fullName = foundEntry.substring(firstSpaceIndex).trim();
                    }
                }
            }

            // 2. Fallback to static database if not found in whitelist
            if (!fullName) {
                fullName = STUDENT_DATABASE[id];
            }

            if (fullName) {
                // Remove titles (นาย, นางสาว, etc.) and take only the first name
                const cleanName = fullName.replace(/^(นาย|นางสาว|นาง|ด\.ช\.|ด\.ญ\.|Mr\.|Ms\.|Mrs\.)/i, '').trim().split(/\s+/)[0];
                return `${id} ${cleanName}`;
            }
            // If no name found, return just ID
            return id;
        }

        // --- Robust Date Helper to Fix Timezone Issues ---
        function getLocalDateString() {
            const d = new Date();
            const offset = d.getTimezoneOffset() * 60000;
            return new Date(d.getTime() - offset).toISOString().split('T')[0];
        }

        window.state = {
            user: null,
            studentId: localStorage.getItem('student_id') || '',
            isLoggedIn: !!localStorage.getItem('student_id'),
            isAdmin: localStorage.getItem('is_admin') === 'true',
            settings: { 
                projectName: "Global Access Project",
                maxHoursPerDay: 2,
                maxTotalHours: 10,
                startTime: "09:00", 
                endTime: "18:00", 
                availableDays: [1, 2, 3, 4, 5], 
                startDate: getLocalDateString(), 
                endDate: "",
                systemStatus: true, // Default open
                closedDates: {}, // Format: { "YYYY-MM-DD": "Reason" }
                announcement: "" // NEW: Announcement Text
            },
            allowedStudents: [], 
            resources: [],
            bookings: [],
            selectedResource: null,
            selectedDate: getLocalDateString(), 
            calendarViewDate: new Date(), 
            publicSelectedResourceId: '', 
            selectedSlots: [], 
            view: 'login', 
            activeBookings: [],
            modal: { show: false, title: '', message: '', type: 'info', onConfirm: null },
            showQRModal: null,
            showHistoryModal: false, 
            editingResource: null,
            
            // NEW STATES
            showAnnouncementModal: false,
            showResourceSelectModal: false,
            resourceSelectOptions: [],
            resourceSelectDate: '',
            
            // SEARCH & ADMIN STATES
            adminSearchQuery: '',
            viewingStudentId: null, // For student detail modal

            isScanning: false,
            isProcessingScan: false,
            whitelistLocked: true, 
            lastScrollTop: 0,
            shouldRestoreScroll: false, 
            hintTimeout: null, 
            expandedHistoryId: null,
            isLoading: false
        };

        const DAYS_TH = ["อา.", "จ.", "อ.", "พ.", "พฤ.", "ศ.", "ส."];
        const MONTHS_TH = ["มกราคม", "กุมภาพันธ์", "มีนาคม", "เมษายน", "พฤษภาคม", "มิถุนายน", "กรกฎาคม", "สิงหาคม", "กันยายน", "ตุลาคม", "พฤศจิกายน", "ธันวาคม"];

        // --- Logic: Utilities ---
        function addMinutes(time, mins) {
            let [h, m] = time.split(':').map(Number);
            let date = new Date(2000, 0, 1, h, m + mins);
            return `${date.getHours().toString().padStart(2, '0')}:${date.getMinutes().toString().padStart(2, '0')}`;
        }

        function formatDateTH(dateStr) {
            if (!dateStr) return "-";
            const parts = dateStr.split('-');
            if (parts.length !== 3) return dateStr;
            return `${parts[2]}/${parts[1]}/${parts[0]}`;
        }
        
        function formatDateShortTH(dateStr) {
            if (!dateStr) return "-";
            const parts = dateStr.split('-');
            if (parts.length !== 3) return dateStr;
            return `${parts[2]}/${parts[1]}`;
        }

        function formatDateTime(ts) {
            if (!ts) return "-";
            const d = ts.toDate ? ts.toDate() : new Date(ts); 
            if (isNaN(d.getTime())) return "-"; 
            return d.toLocaleString('th-TH', { hour12: false });
        }
        
        function formatTimeOnly(ts) {
            if (!ts) return "-";
            const d = ts.toDate ? ts.toDate() : new Date(ts); 
            if (isNaN(d.getTime())) return "-"; 
            return d.toLocaleTimeString('th-TH', { hour: '2-digit', minute: '2-digit', hour12: false });
        }

        function getPossibleSlotsCount() {
            let current = new Date(`2000-01-01T${window.state.settings.startTime}`);
            let endLimit = new Date(`2000-01-01T${window.state.settings.endTime}`);
            let count = 0;
            while (current < endLimit) {
                count++;
                current.setHours(current.getHours() + 1);
            }
            return count;
        }

        // --- Helper: Save Scroll Position ---
        window.saveScrollPosition = () => {
            const container = document.querySelector('.scrollable-content');
            if (container) {
                window.state.lastScrollTop = container.scrollTop;
                window.state.shouldRestoreScroll = true;
            }
        };

        window.formatBookingRanges = (bookingList) => {
            if (!bookingList || bookingList.length === 0) return "ไม่มีข้อมูลเวลา";
            const sorted = [...bookingList].sort((a, b) => a.slot.localeCompare(b.slot));
            let ranges = [];
            if (sorted.length > 0) {
                let start = sorted[0].slot;
                let currentEnd = sorted[0].slot_end || addMinutes(start, 59);
                for (let i = 1; i < sorted.length; i++) {
                    if (sorted[i].slot === currentEnd || sorted[i].slot === addMinutes(currentEnd, 1)) {
                        currentEnd = sorted[i].slot_end || addMinutes(sorted[i].slot, 59);
                    } else {
                        ranges.push(`${start} - ${currentEnd}`);
                        start = sorted[i].slot;
                        currentEnd = sorted[i].slot_end || addMinutes(start, 59);
                    }
                }
                ranges.push(`${start} - ${currentEnd}`);
            }
            return ranges.join(", ");
        };

        // --- NEW: Check and Clear Expired Sessions ---
        const checkAutoClear = async () => {
            if (!window.state.resources || !window.state.bookings) return;
            const todayStr = getLocalDateString();
            const now = new Date();
            const currentHm = now.getHours().toString().padStart(2,'0') + ':' + now.getMinutes().toString().padStart(2,'0');
            const systemEndTime = window.state.settings.endTime || "23:59";

            const inUseResources = window.state.resources.filter(r => r.status === 'in_use');
            
            for (const res of inUseResources) {
                const activeBookings = window.state.bookings.filter(b => 
                    b.resourceId === res.id && 
                    b.studentId === res.currentStudent && 
                    b.date === todayStr && 
                    b.status === 'checked_in'
                );

                if (activeBookings.length > 0) {
                    if (currentHm > systemEndTime) {
                        for(let b of activeBookings) {
                            await updateDoc(doc(db, 'artifacts', fbId, 'public', 'data', 'bookings', b.id), { 
                                status: 'completed',
                                checkOutAt: new Date().toISOString()
                            });
                        }
                        await updateDoc(doc(db, 'artifacts', fbId, 'public', 'data', 'resources', res.id), { 
                            status: 'idle', 
                            currentStudent: null, 
                            startedAt: null 
                        });
                    }
                }
            }
        };

        // --- Firebase Core ---
        async function init() {
            try {
                await signInAnonymously(auth);
                onAuthStateChanged(auth, (u) => {
                    window.state.user = u;
                    if (u) listenToData();
                });
                
                setInterval(checkAutoClear, 10000);
            } catch (err) { window.uiAlert("Firebase Error: " + err.message, "error"); }
        }

        function listenToData() {
            onSnapshot(doc(db, 'artifacts', fbId, 'public', 'data', 'settings', 'global_config'), (s) => {
                if (s.exists()) {
                    const data = s.data();
                    window.state.settings = { ...window.state.settings, ...data };
                    
                    // Trigger Announcement Modal on First Load if content exists
                    if (data.announcement && !sessionStorage.getItem('seenAnnouncement')) {
                        window.state.showAnnouncementModal = true;
                        sessionStorage.setItem('seenAnnouncement', 'true');
                    }
                }
                window.saveScrollPosition(); 
                render();
            });
            onSnapshot(doc(db, 'artifacts', fbId, 'public', 'data', 'settings', 'allowed_students'), (s) => {
                if (s.exists()) window.state.allowedStudents = s.data().list || [];
                window.saveScrollPosition();
                render();
            });
            onSnapshot(collection(db, 'artifacts', fbId, 'public', 'data', 'resources'), (s) => {
                window.state.resources = s.docs
                    .map(d => ({ id: d.id, ...d.data() }))
                    .sort((a, b) => (a.order || 0) - (b.order || 0));
                
                if (window.state.resources.length > 0 && !window.state.publicSelectedResourceId) {
                    window.state.publicSelectedResourceId = window.state.resources[0].id;
                }
                window.saveScrollPosition();
                render();
            });
            onSnapshot(collection(db, 'artifacts', fbId, 'public', 'data', 'bookings'), (s) => {
                window.state.bookings = s.docs.map(d => ({ id: d.id, ...d.data() }));
                window.saveScrollPosition();
                render();
            });
        }

        // --- Functions ---
        const setView = (v) => { 
            window.state.view = v;
            if (!window.state.shouldRestoreScroll) {
                window.state.lastScrollTop = 0;
            }
            
            if (v !== 'scanner' && window.html5QrScanner) {
                if (window.html5QrScanner.stop) { window.html5QrScanner.stop().catch(() => {}); }
                window.html5QrScanner = null;
                window.state.isScanning = false;
                window.state.isProcessingScan = false;
            }
            render(); 
        };
        
        const goHome = () => {
            window.state.activeBookings = [];
            window.state.selectedSlots = [];
            window.state.selectedResource = null;
            window.state.view = 'selection';
            window.state.lastScrollTop = 0;
            window.state.shouldRestoreScroll = false;
            
            if (window.html5QrScanner) {
                try {
                    window.html5QrScanner.stop().catch(() => {});
                } catch(e) {}
                window.html5QrScanner = null;
            }
            window.state.isScanning = false;
            window.state.isProcessingScan = false;
            
            render();
        };

        // --- UPDATED: Login Logic ---
        const handleLogin = (e) => {
            e.preventDefault();
            const input = document.getElementById('login_sid').value.trim();
            if (input === "Admin123") {
                window.state.isAdmin = true;
                window.state.isLoggedIn = true;
                window.state.studentId = "ADMIN";
                localStorage.setItem('is_admin', 'true');
            } else if (input.length >= 5) {
                // Check whitelist if it exists
                if (window.state.allowedStudents.length > 0) {
                    // Check if any entry starts with the input ID
                    // We split by whitespace to get the first token (ID) of the stored line
                    const isAllowed = window.state.allowedStudents.some(entry => {
                        const storedId = entry.split(/[\s\t]+/)[0];
                        return storedId === input;
                    });
                    
                    if (!isAllowed) {
                        return window.uiAlert("รหัสนักศึกษานี้ไม่ได้รับอนุญาตให้ใช้งานระบบ", "error");
                    }
                }
                
                window.state.isAdmin = false;
                window.state.isLoggedIn = true;
                window.state.studentId = input;
                localStorage.setItem('student_id', input);
                localStorage.setItem('is_admin', 'false');
            } else { return window.uiAlert("ข้อมูลไม่ถูกต้อง", "error"); }
            window.state.view = 'selection';
            render();
        };

        const logout = () => { 
            window.uiConfirm("ออกจากระบบ", "คุณต้องการออกจากระบบใช่หรือไม่?", () => {
                localStorage.clear();
                sessionStorage.clear(); // Clear session to show announcement again on relogin
                window.state.isLoggedIn = false; 
                window.state.isAdmin = false;
                window.state.view = 'login';
                render();
            });
        };

        // ... [Previous functions for booking, selection, etc. remain the same] ...
        
        // --- ADMIN SEARCH FUNCTIONS (NEW) ---
        window.handleAdminSearch = (e) => {
            const query = e.target.value.trim().toLowerCase();
            window.state.adminSearchQuery = e.target.value; // Sync state
            const resultsContainer = document.getElementById('admin-search-results');
            
            if (query.length < 2) {
                resultsContainer.innerHTML = '<p class="text-center text-slate-300 text-xs py-4">พิมพ์อย่างน้อย 2 ตัวอักษรเพื่อค้นหา</p>';
                return;
            }

            // 1. Collect unique IDs matching query
            const matches = new Set();
            
            // From Whitelist
            if (window.state.allowedStudents) {
                window.state.allowedStudents.forEach(entry => {
                    const id = entry.split(/[\s\t]+/)[0];
                    if (id.includes(query)) matches.add(id);
                });
            }
            
            // From Bookings (History)
            if (window.state.bookings) {
                window.state.bookings.forEach(b => {
                    if (b.studentId && b.studentId.includes(query) && b.studentId !== 'ADMIN') matches.add(b.studentId);
                });
            }

            const uniqueIds = Array.from(matches).sort();

            if (uniqueIds.length === 0) {
                resultsContainer.innerHTML = '<p class="text-center text-slate-300 text-xs py-4">ไม่พบข้อมูลในระบบ</p>';
                return;
            }

            // Render Results Directly to DOM (No Full Render)
            resultsContainer.innerHTML = uniqueIds.map(id => {
                const name = getDisplayName(id); 
                const history = window.state.bookings.filter(b => b.studentId === id);
                
                return `
                    <button onclick="window.openStudentDetail('${id}')" class="w-full p-4 bg-white border border-slate-100 rounded-2xl hover:bg-indigo-50 hover:border-indigo-200 transition-all flex items-center justify-between group text-left shadow-sm mb-2">
                        <div class="flex items-center gap-4">
                            <div class="w-10 h-10 rounded-full bg-slate-100 text-slate-500 flex items-center justify-center font-bold text-xs group-hover:bg-indigo-500 group-hover:text-white transition-colors flex-shrink-0">
                                <i data-lucide="user" size="16"></i>
                            </div>
                            <div class="overflow-hidden">
                                <p class="font-black text-slate-800 text-sm group-hover:text-indigo-700 truncate">${name}</p>
                                <p class="text-[10px] text-slate-400 font-bold uppercase tracking-wider">ID: ${id}</p>
                            </div>
                        </div>
                        <div class="text-right flex-shrink-0">
                            <span class="text-[9px] font-bold bg-slate-100 text-slate-500 px-2 py-1 rounded-lg group-hover:bg-white group-hover:text-indigo-500">History: ${history.length}</span>
                        </div>
                    </button>
                `;
            }).join('');
            
            // Re-initialize icons for newly added elements
            lucide.createIcons();
        };

        window.openStudentDetail = (id) => {
            window.saveScrollPosition();
            window.state.viewingStudentId = id;
            window.render();
        };

        window.closeStudentDetail = () => {
            window.state.viewingStudentId = null;
            window.render();
        };

        // ------------------------------------

        const selectResource = (id) => { 
            const res = window.state.resources.find(r => r.id === id);
            if (!res) return;
            window.state.selectedResource = { ...res }; 
            window.state.selectedSlots = [];
            window.state.view = 'calendar'; 
            window.state.lastScrollTop = 0;
            window.state.shouldRestoreScroll = false;
            render(); 
        };

        // --- UPDATED: Fix for Multiple Resources on Same Date ---
        const goToDate = (dateStr) => {
             window.closeHistoryModal();
             
             // 1. Get all bookings for this user on this date
             const myBookingsOnDate = window.state.bookings.filter(b => 
                 b.studentId === window.state.studentId && 
                 b.date === dateStr
             );

             if (myBookingsOnDate.length === 0) return;

             // 2. Extract unique resource IDs involved
             const uniqueResourceIds = [...new Set(myBookingsOnDate.map(b => b.resourceId))];

             // 3. Logic: If more than 1 resource, show selection modal
             if (uniqueResourceIds.length > 1) {
                 window.state.resourceSelectDate = dateStr;
                 window.state.resourceSelectOptions = uniqueResourceIds.map(rid => {
                     const r = window.state.resources.find(res => res.id === rid);
                     // If resource deleted, provide fallback name
                     const bookingRef = myBookingsOnDate.find(b => b.resourceId === rid);
                     return r ? r : { id: rid, name: bookingRef?.resourceName || 'Unknown Resource', description: '' };
                 });
                 window.state.showResourceSelectModal = true;
                 render();
             } else {
                 // Single resource case (Old Logic)
                 const booking = myBookingsOnDate[0];
                 const currentRes = window.state.resources.find(r => r.id === booking.resourceId);
                 if (currentRes) {
                     window.state.selectedResource = { ...currentRes };
                 } else {
                     window.state.selectedResource = { id: booking.resourceId, name: booking.resourceName, description: '' };
                 }
                 
                 window.state.selectedDate = dateStr;
                 window.state.view = 'calendar';
                 window.state.lastScrollTop = 0;
                 window.render();
                 setTimeout(() => { window.scrollToTarget(); }, 300);
             }
        };

        const selectResourceFromDate = (resId) => {
            window.state.showResourceSelectModal = false;
            // Find resource info
            const currentRes = window.state.resources.find(r => r.id === resId);
            const dateStr = window.state.resourceSelectDate;
            
            if (currentRes) {
                window.state.selectedResource = { ...currentRes };
            } else {
                // Fallback name lookup
                const booking = window.state.bookings.find(b => b.resourceId === resId && b.date === dateStr);
                window.state.selectedResource = { id: resId, name: booking?.resourceName || 'Unknown', description: '' };
            }
            
            window.state.selectedDate = dateStr;
            window.state.view = 'calendar';
            window.state.lastScrollTop = 0;
            render();
            setTimeout(() => { window.scrollToTarget(); }, 300);
        };

        const toggleSlotSelection = (slotObj) => {
            window.saveScrollPosition();
            
            if (window.state.settings.closedDates && window.state.settings.closedDates[window.state.selectedDate]) {
                const reason = window.state.settings.closedDates[window.state.selectedDate];
                return window.uiAlert(`ไม่สามารถจองได้: วันนี้ปิดให้บริการ (${reason})`, "error");
            }

            const todayStr = getLocalDateString();
            if (window.state.selectedDate < todayStr) {
                return window.uiAlert("วันเวลาที่ผ่านมาแล้ว ไม่สามารถจองย้อนหลังได้", "error");
            }

            const index = window.state.selectedSlots.findIndex(s => s.start === slotObj.start);
            if (index > -1) {
                window.state.selectedSlots.splice(index, 1);
            } else {
                const dailyBooked = window.state.bookings.filter(b => b.studentId === window.state.studentId && b.date === window.state.selectedDate).length; // แก้ไข: นับรวม completed ด้วยเพื่อให้โควตาไม่หาย
                if (dailyBooked + window.state.selectedSlots.length >= window.state.settings.maxHoursPerDay) {
                    return window.uiAlert(`เกินโควตาต่อวัน! (${window.state.settings.maxHoursPerDay} ชม./วัน)`, "error");
                }
                const totalBooked = window.state.bookings.filter(b => b.studentId === window.state.studentId).length; // แก้ไข: นับรวม completed ด้วย
                if (totalBooked + window.state.selectedSlots.length >= window.state.settings.maxTotalHours) {
                    return window.uiAlert(`เกินโควตาทั้งหมด! (${window.state.settings.maxTotalHours} ชม.)`, "error");
                }

                if (window.state.selectedDate === todayStr && window.state.selectedSlots.length === 0) {
                    window.uiAlert("ข้อควรระวัง: การจองรอบเวลาของ \"วันนี้\" เมื่อยืนยันแล้วจะไม่สามารถยกเลิกได้", "info");
                }

                window.state.selectedSlots.push(slotObj);
            }
            window.state.shouldRestoreScroll = true;
            render();
        };

        const confirmBookingAction = async () => {
            const todayStr = getLocalDateString();
            if (window.state.selectedDate < todayStr) {
                return window.uiAlert("วันเวลาที่ผ่านมาแล้ว ไม่สามารถจองย้อนหลังได้", "error");
            }
            
            window.saveScrollPosition();
            window.state.isLoading = true;
            render();

            try {
                // ใช้ Transaction เพื่อป้องกัน Race Condition (จองพร้อมกัน)
                await runTransaction(db, async (transaction) => {
                    const bookingsToCreate = [];
                    
                    for (const slotObj of window.state.selectedSlots) {
                        // สร้าง ID แบบระบุเจาะจง (Resource + Date + Time) เพื่อให้มีได้แค่ไฟล์เดียว
                        const safeSlot = slotObj.start.replace(':', '-');
                        const docId = `${window.state.selectedResource.id}_${window.state.selectedDate}_${safeSlot}`;
                        const docRef = doc(db, 'artifacts', fbId, 'public', 'data', 'bookings', docId);
                        
                        // อ่านข้อมูลก่อน (Atomicity Check)
                        const sfDoc = await transaction.get(docRef);
                        if (sfDoc.exists()) {
                            throw `ช่วงเวลา ${slotObj.start} ถูกจองไปแล้วโดยผู้อื่น`;
                        }
                        
                        // เช็คแบบ Legacy (เผื่อมีข้อมูลเก่าที่ ID เป็นแบบสุ่ม)
                        const legacyConflict = window.state.bookings.find(b => 
                            b.resourceId === window.state.selectedResource.id &&
                            b.date === window.state.selectedDate &&
                            b.slot === slotObj.start
                        );
                        if (legacyConflict) {
                             throw `ช่วงเวลา ${slotObj.start} ไม่ว่าง (ข้อมูลไม่อัปเดต)`;
                        }

                        bookingsToCreate.push({ ref: docRef, slot: slotObj });
                    }

                    // ถ้าผ่านทุกเงื่อนไข ทำการบันทึก
                    for (const item of bookingsToCreate) {
                        const data = {
                            resourceId: window.state.selectedResource.id,
                            resourceName: window.state.selectedResource.name,
                            date: window.state.selectedDate,
                            slot: item.slot.start,
                            slot_end: item.slot.end,
                            studentId: window.state.studentId,
                            status: 'booked',
                            createdAt: serverTimestamp()
                        };
                        transaction.set(item.ref, data);
                    }
                });

                // สร้างข้อมูลจำลองเพื่อแสดงผลทันที (ไม่ต้องรอ Snapshot)
                const confirmedItems = window.state.selectedSlots.map(slotObj => {
                    const safeSlot = slotObj.start.replace(':', '-');
                    return {
                        id: `${window.state.selectedResource.id}_${window.state.selectedDate}_${safeSlot}`,
                        resourceId: window.state.selectedResource.id,
                        resourceName: window.state.selectedResource.name,
                        date: window.state.selectedDate,
                        slot: slotObj.start,
                        slot_end: slotObj.end,
                        studentId: window.state.studentId,
                        status: 'booked',
                        createdAt: new Date(),
                        checkInAt: null,
                        checkOutAt: null
                    };
                });

                window.state.selectedSlots = [];
                window.state.activeBookings = confirmedItems;
                window.state.view = 'pass'; 
                window.state.lastScrollTop = 0; 
                window.state.shouldRestoreScroll = false;
            } catch (err) { 
                // แสดงข้อความแจ้งเตือนเมื่อชนกัน
                let msg = err.message || err.toString();
                if (msg.includes("ถูกจอง")) {
                    window.uiAlert("เสียใจด้วย! " + msg, "error");
                } else {
                    window.uiAlert("Booking failed: " + msg, "error");
                }
                // ล้างการเลือกเพื่อให้ผู้ใช้เลือกใหม่
                window.state.selectedSlots = [];
            } finally {
                window.state.isLoading = false;
                render();
            }
        };

        const viewPassToday = () => {
            const myToday = window.state.bookings.filter(b => 
                b.studentId === window.state.studentId && 
                b.date === window.state.selectedDate && 
                b.resourceId === window.state.selectedResource.id
            );
            
            if (myToday.length === 0) {
                window.uiAlert("ไม่พบข้อมูลการจองสำหรับวันนี้", "error");
                return;
            }

            window.state.activeBookings = myToday;
            setView('pass');
        };

        const initScanner = (mode = 'checkin') => {
            if (window.state.isScanning) return;
            window.state.isScanning = true;
            window.html5QrScanner = new Html5Qrcode("reader");
            window.html5QrScanner.start({ facingMode: "environment" }, { fps: 20, qrbox: 280, aspectRatio: 1.0 }, async (text) => {
                if (window.state.isProcessingScan) return;
                window.state.isProcessingScan = true;
                // ถ้า activeBookings ว่าง ให้ลองดึงใหม่จาก state.bookings (ป้องกันกรณี refresh หรือ data lost)
                if (!window.state.activeBookings || window.state.activeBookings.length === 0) {
                     window.state.activeBookings = window.state.bookings.filter(b => 
                        b.studentId === window.state.studentId && 
                        b.date === getLocalDateString() &&
                        b.resourceId === window.state.selectedResource?.id
                    );
                }
                const targetId = window.state.activeBookings[0]?.resourceId;
                
                if (text === targetId) {
                    window.html5QrScanner.stop().then(() => { 
                        // FIX: Explicitly nullify scanner to clear state for goHome button
                        window.html5QrScanner = null;
                        window.state.isScanning = false;
                        if (mode === 'checkout') {
                             processCheckOut(targetId);
                        } else {
                             processCheckIn(targetId);
                        }
                    });
                } else { 
                    window.html5QrScanner.stop().then(() => {
                        window.html5QrScanner = null; // FIX: Ensure clean state on error too
                        window.state.isScanning = false;
                        window.state.isProcessingScan = false;
                        window.uiAlert("คิวอาร์ไม่ถูกต้อง", "error");
                        setView('pass');
                    });
                }
            }, () => {}).catch(err => { window.uiAlert("กล้องขัดข้อง: " + err, "error"); setView('pass'); });
        };

        const processCheckIn = async (resId) => {
            const nowISO = new Date().toISOString();
            
            // 1. Optimistic Update (อัปเดตหน้าจอทันที ไม่ต้องรอ Firebase)
            window.state.activeBookings.forEach(b => {
                b.status = 'checked_in';
                b.checkInAt = nowISO;
            });
            // อัปเดต state หลักด้วยเพื่อให้หน้าอื่นเห็นผลทันที
            window.state.bookings = window.state.bookings.map(b => {
                const active = window.state.activeBookings.find(ab => ab.id === b.id);
                return active ? { ...b, status: 'checked_in', checkInAt: nowISO } : b;
            });

            // 2. Render ทันทีเพื่อให้ปุ่มเปลี่ยน
            window.state.view = 'pass';
            window.state.isProcessingScan = false;
            render();

            // 3. ส่งข้อมูลเข้า Firebase (Background sync)
            for (const b of window.state.activeBookings) {
                await updateDoc(doc(db, 'artifacts', fbId, 'public', 'data', 'bookings', b.id), { status: 'checked_in', checkInAt: nowISO });
            }
            await updateDoc(doc(db, 'artifacts', fbId, 'public', 'data', 'resources', resId), { status: 'in_use', currentStudent: window.state.studentId, startedAt: nowISO });
        };

        const processCheckOut = async (resId) => {
            const nowISO = new Date().toISOString();

            // 1. Optimistic Update (อัปเดตหน้าจอทันที)
            window.state.activeBookings.forEach(b => {
                if (b.status === 'checked_in') {
                    b.status = 'completed';
                    b.checkOutAt = nowISO;
                }
            });
            // อัปเดต state หลัก (สำคัญมากเพื่อให้ history ไม่หาย)
            window.state.bookings = window.state.bookings.map(b => {
                const active = window.state.activeBookings.find(ab => ab.id === b.id);
                return active ? { ...b, status: 'completed', checkOutAt: nowISO } : b;
            });

            // 2. Render ทันที
            window.state.view = 'pass';
            window.state.isProcessingScan = false;
            render();

            // 3. ส่งข้อมูลเข้า Firebase
            for (const b of window.state.activeBookings) {
                // อัปเดตเฉพาะอันที่ยังไม่ completed (ป้องกันการเขียนซ้ำถ้า network ช้า)
                await updateDoc(doc(db, 'artifacts', fbId, 'public', 'data', 'bookings', b.id), { status: 'completed', checkOutAt: nowISO });
            }
            await updateDoc(doc(db, 'artifacts', fbId, 'public', 'data', 'resources', resId), { status: 'idle', currentStudent: null, startedAt: null });
        };

        const saveSettings = async (e) => {
            e.preventDefault();
            window.saveScrollPosition();

            const f = new FormData(e.target);
            const days = DAYS_TH.map((_, i) => f.get(`day-${i}`) ? i : null).filter(x => x !== null);
            const currentSettings = window.state.settings;
            
            await setDoc(doc(db, 'artifacts', fbId, 'public', 'data', 'settings', 'global_config'), {
                ...currentSettings,
                projectName: f.get('projectName'),
                maxHoursPerDay: parseInt(f.get('maxHoursDay')),
                maxTotalHours: parseInt(f.get('maxHoursTotal')),
                startTime: f.get('startTime'),
                endTime: f.get('endTime'),
                startDate: f.get('startDate'),
                endDate: f.get('endDate'),
                availableDays: days
            });
            window.uiAlert("บันทึกเรียบร้อยแล้ว");
        };

        // NEW: Save Announcement Text
        const saveAnnouncement = async (e) => {
            e.preventDefault();
            const text = e.target.announcement.value;
            await updateDoc(doc(db, 'artifacts', fbId, 'public', 'data', 'settings', 'global_config'), {
                announcement: text
            });
            window.uiAlert("บันทึกประกาศเรียบร้อยแล้ว");
        };

        const toggleSystemStatus = async () => {
            const newStatus = !window.state.settings.systemStatus;
            await updateDoc(doc(db, 'artifacts', fbId, 'public', 'data', 'settings', 'global_config'), {
                systemStatus: newStatus
            });
            window.uiAlert(`ระบบ ${newStatus ? 'เปิด' : 'ปิด'} เรียบร้อยแล้ว`);
        };

        const addClosedDate = async (e) => {
            e.preventDefault();
            const date = e.target.date.value;
            const reason = e.target.reason.value;
            if (!date || !reason) return;

            const newClosedDates = { ...window.state.settings.closedDates, [date]: reason };
            await updateDoc(doc(db, 'artifacts', fbId, 'public', 'data', 'settings', 'global_config'), {
                closedDates: newClosedDates
            });
            e.target.reset();
        };

        const removeClosedDate = async (date) => {
            const newClosedDates = { ...window.state.settings.closedDates };
            delete newClosedDates[date];
            await updateDoc(doc(db, 'artifacts', fbId, 'public', 'data', 'settings', 'global_config'), {
                closedDates: newClosedDates
            });
        };

        // --- UPDATED: Save Whitelist Logic ---
        const saveWhitelist = async (e) => {
            e.preventDefault();
            window.saveScrollPosition();

            const raw = e.target.studentsList.value;
            // Split by newline characters to separate entries, preserving names
            const list = raw.split(/\r?\n/)
                .map(s => s.trim())
                .filter(s => s.length > 0); // Filter out empty lines only
            
            await setDoc(doc(db, 'artifacts', fbId, 'public', 'data', 'settings', 'allowed_students'), { list: list, updatedAt: serverTimestamp() });
            window.uiAlert(`บันทึก ${list.length} รายชื่อเรียบร้อย`);
        };

        const addRes = async (e) => {
            e.preventDefault();
            window.saveScrollPosition();

            const name = e.target.resName.value.trim();
            const description = e.target.resDesc.value.trim(); // รับค่า Description
            if (name) await addDoc(collection(db, 'artifacts', fbId, 'public', 'data', 'resources'), { 
                name, 
                description, 
                status: 'idle', 
                order: Date.now() 
            });
            e.target.reset();
        };

        const deleteResource = (id) => window.uiConfirm("ลบทรัพยากร", "ต้องการลบใช่หรือไม่?", async () => {
            window.saveScrollPosition();
            await deleteDoc(doc(db, 'artifacts', fbId, 'public', 'data', 'resources', id));
        });
        
        // --- NEW: Edit Resource Functions (Modal Based) ---
        const openEditResourceModal = (id) => {
            window.saveScrollPosition();
            const res = window.state.resources.find(r => r.id === id);
            if(res) {
                window.state.editingResource = { ...res };
                window.render();
            }
        };

        const closeEditResourceModal = () => {
            window.state.editingResource = null;
            window.render();
        };

        const saveEditResource = async (e) => {
            e.preventDefault();
            const id = window.state.editingResource.id;
            const newName = e.target.editResName.value.trim();
            const newDesc = e.target.editResDesc.value.trim();

            if (newName) {
                await updateDoc(doc(db, 'artifacts', fbId, 'public', 'data', 'resources', id), { 
                    name: newName,
                    description: newDesc 
                });
                window.state.editingResource = null;
                window.uiAlert("บันทึกการแก้ไขเรียบร้อย");
            }
        };

        const moveResource = async (id, direction) => {
            window.saveScrollPosition();

            const items = [...window.state.resources].sort((a, b) => (a.order || 0) - (b.order || 0));
            const index = items.findIndex(i => i.id === id);
            
            if (index === -1) return;
            if (direction === 'up' && index === 0) return;
            if (direction === 'down' && index === items.length - 1) return;

            const target = items[index];
            const swapWith = direction === 'up' ? items[index - 1] : items[index + 1];

            const needsReindex = items.some(i => typeof i.order !== 'number') || items.some((i, idx) => i.order === (items[idx+1]?.order));
            
            if (needsReindex) {
                 const updates = items.map((item, idx) => {
                     const newOrder = idx * 1000;
                     item.order = newOrder; 
                     return updateDoc(doc(db, 'artifacts', fbId, 'public', 'data', 'resources', item.id), { order: newOrder });
                 });
                 await Promise.all(updates);
            }

            const tempOrder = target.order;
            const newTargetOrder = swapWith.order;
            const newSwapOrder = tempOrder;

            await updateDoc(doc(db, 'artifacts', fbId, 'public', 'data', 'resources', target.id), { order: newTargetOrder });
            await updateDoc(doc(db, 'artifacts', fbId, 'public', 'data', 'resources', swapWith.id), { order: newSwapOrder });
        };

        const delBooking = (id) => {
            const b = window.state.bookings.find(x => x.id === id);
            if (!b) return;
            
            const todayStr = getLocalDateString();

            if (!window.state.isAdmin && (b.status === 'checked_in' || b.status === 'completed')) {
                return window.uiAlert("ไม่สามารถยกเลิกรายการที่เช็คอินแล้วได้", "error");
            }

            if (!window.state.isAdmin && b.date === todayStr) {
                return window.uiAlert("ไม่สามารถยกเลิกการจองในวันใช้งานได้\nต้องดำเนินการล่วงหน้าอย่างน้อย 1 วัน", "error");
            }

            window.saveScrollPosition();
            const isPast = b.date < todayStr;
            const title = isPast ? "ลบประวัติ" : "ยกเลิกการจอง";
            const msg = isPast ? "ต้องการลบประวัติรายการนี้ใช่หรือไม่?" : "ต้องการยกเลิกการจองนี้ใช่หรือไม่?";

            window.uiConfirm(title, msg, async () => {
                window.saveScrollPosition();
                await deleteDoc(doc(db, 'artifacts', fbId, 'public', 'data', 'bookings', id));
                
                if (b.status === 'checked_in') {
                    const otherActive = window.state.bookings.filter(ob => 
                        ob.id !== id && 
                        ob.resourceId === b.resourceId && 
                        ob.studentId === b.studentId && 
                        ob.date === b.date &&
                        ob.status === 'checked_in'
                    );
                    
                    if (otherActive.length === 0) {
                        await updateDoc(doc(db, 'artifacts', fbId, 'public', 'data', 'resources', b.resourceId), { 
                            status: 'idle', 
                            currentStudent: null, 
                            startedAt: null 
                        });
                    }
                }
            });
        };

        const toggleHistoryItem = (id) => {
             window.saveScrollPosition();
             if (window.state.expandedHistoryId === id) {
                 window.state.expandedHistoryId = null;
             } else {
                 window.state.expandedHistoryId = id;
             }
             window.render();
        };

        const clearMyHistory = () => {
             window.uiConfirm("ล้างประวัติทั้งหมด", "คุณต้องการลบประวัติการจองทั้งหมดของคุณใช่หรือไม่?", async () => {
                 window.saveScrollPosition();
                 const myBookings = window.state.bookings.filter(b => b.studentId === window.state.studentId);
                 for (const b of myBookings) {
                     await deleteDoc(doc(db, 'artifacts', fbId, 'public', 'data', 'bookings', b.id));
                 }
                 window.uiAlert("ล้างประวัติเรียบร้อยแล้ว");
             });
        };

        const getActiveBookingDates = () => {
            const counts = {};
            window.state.bookings.forEach(b => {
                counts[b.date] = (counts[b.date] || 0) + 1;
            });
            return Object.entries(counts).sort((a, b) => b[0].localeCompare(a[0]));
        };

        const clearByDay = (d) => {
            window.uiConfirm("ลบข้อมูลรายวัน", `ต้องการลบข้อมูลการจองทั้งหมดของวันที่ ${formatDateTH(d)}?`, async () => {
                window.saveScrollPosition();
                const toDelete = window.state.bookings.filter(x => x.date === d);
                for(const b of toDelete) {
                    await deleteDoc(doc(db, 'artifacts', fbId, 'public', 'data', 'bookings', b.id));
                }
                
                const todayStr = getLocalDateString();
                if (d === todayStr) {
                     const inUseResources = window.state.resources.filter(r => r.status === 'in_use');
                     for (const r of inUseResources) {
                         await updateDoc(doc(db, 'artifacts', fbId, 'public', 'data', 'resources', r.id), { 
                            status: 'idle', 
                            currentStudent: null, 
                            startedAt: null 
                        });
                     }
                }
                
                window.uiAlert(`ลบข้อมูล ${toDelete.length} รายการเรียบร้อย`);
            });
        };

        const clearAllHistory = () => window.uiConfirm("ล้างฐานข้อมูล", "ต้องการลบทั้งหมดหรือไม่?", async () => {
            for(const b of window.state.bookings) await deleteDoc(doc(db, 'artifacts', fbId, 'public', 'data', 'bookings', b.id));
            
            for(const r of window.state.resources) {
                if (r.status !== 'idle') {
                    await updateDoc(doc(db, 'artifacts', fbId, 'public', 'data', 'resources', r.id), { 
                        status: 'idle', 
                        currentStudent: null, 
                        startedAt: null 
                    });
                }
            }
        });

        const openHistoryModal = () => { window.state.showHistoryModal = true; render(); };
        const closeHistoryModal = () => { window.state.shouldRestoreScroll = true; window.state.showHistoryModal = false; window.render(); };

        window.uiAlert = (message, type = 'info') => {
            window.saveScrollPosition();
            window.state.modal = { show: true, title: type === 'error' ? 'ข้อผิดพลาด' : type === 'success' ? 'สำเร็จ' : 'แจ้งเตือน', message, type, onConfirm: null };
            render();
        };
        window.uiConfirm = (title, message, onConfirm) => {
            window.saveScrollPosition();
            window.state.modal = { show: true, title, message, type: 'confirm', onConfirm };
            render();
        };
        const closeModal = () => { 
            window.state.shouldRestoreScroll = true;
            window.state.modal.show = false; 
            render(); 
        };
        // FIXED: Added window.saveScrollPosition() to prevent jumping
        const openQRModal = (id, name) => { window.saveScrollPosition(); window.state.showQRModal = { id, name }; render(); };
        const closeQRModal = () => { window.state.shouldRestoreScroll = true; window.state.showQRModal = null; window.render(); };
        
        const requestCameraPermission = (mode) => {
            const actionText = mode === 'checkout' ? "เช็คเอาท์ (คืนทรัพยากร)" : "เช็คอิน";
            // ข้ามการแจ้งเตือน Permission ถ้าเคยขอแล้ว (เพื่อให้เร็วขึ้น) แต่ในที่นี้เพื่อความชัวร์จะเรียก setView เลย
            setView('scanner');
        };

        const isServiceAvailable = (dateStr) => {
            if (window.state.settings.systemStatus === false) return false;
            if (window.state.settings.closedDates && window.state.settings.closedDates[dateStr]) {
                return true;
            }

            const d = new Date(dateStr);
            const isInRange = (!window.state.settings.startDate || dateStr >= window.state.settings.startDate) &&
                              (!window.state.settings.endDate || dateStr <= window.state.settings.endDate);
            return isInRange && window.state.settings.availableDays.includes(d.getDay());
        };

        // --- Logic: Scroll to Target ---
        const scrollToTarget = () => {
            let targetId = null;
            if (window.state.view === 'calendar') targetId = 'quota-container';
            else if (!window.state.selectedResource && window.state.view !== 'login') targetId = 'resource-list';
            else if (window.state.view === 'selection') targetId = 'resource-list';
            
            const target = targetId ? document.getElementById(targetId) : null;
            if (target) {
                target.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }
        };

        const setupScrollHint = () => {
            const container = document.querySelector('.scrollable-content');
            const hint = document.getElementById('scroll-hint');
            
            let targetId = null;
            if (window.state.view === 'calendar') targetId = 'quota-container';
            else if (!window.state.selectedResource && window.state.view !== 'login' && window.state.view !== 'scanner' && window.state.view !== 'pass') {
                 targetId = 'resource-list';
            } else if (window.state.view === 'selection') {
                 targetId = 'resource-list';
            }

            const target = targetId ? document.getElementById(targetId) : null;

            if (!container || !hint) return;

            hint.style.opacity = '0';
            hint.style.pointerEvents = 'none';
            if (window.state.hintTimeout) clearTimeout(window.state.hintTimeout);

            if (target) {
                const checkVisibility = () => {
                    const rect = target.getBoundingClientRect();
                    const isVisible = rect.top < (window.innerHeight - 100); 
                    return isVisible;
                };

                window.state.hintTimeout = setTimeout(() => {
                    if (!checkVisibility()) {
                        hint.style.opacity = '1';
                        hint.style.pointerEvents = 'auto'; 
                        hint.style.transform = 'translate(-50%, 0)';
                        hint.style.cursor = 'pointer';
                    }
                }, 2000); 

                container.onscroll = () => {
                    window.state.lastScrollTop = container.scrollTop;
                    if (checkVisibility()) {
                        hint.style.opacity = '0';
                        hint.style.pointerEvents = 'none';
                        hint.style.transform = 'translate(-50%, 10px)';
                    }
                };
            }
        };

        function renderActiveUserCard(resourceId, forceShow = false) {
            const todayStr = getLocalDateString();
            
            if (!forceShow && window.state.selectedDate !== todayStr) return '';

            const res = window.state.resources.find(r => r.id === resourceId);
            if (!res || res.status !== 'in_use' || !res.currentStudent) return '';

            const activeBookings = window.state.bookings.filter(b => 
                b.resourceId === res.id && 
                b.studentId === res.currentStudent && 
                b.date === todayStr && 
                b.status === 'checked_in'
            );
            
            if (activeBookings.length === 0) return '';

            const timeRange = window.formatBookingRanges(activeBookings);
            
            return `
                <div class="w-full p-4 bg-indigo-50/80 backdrop-blur-sm border-2 border-indigo-200 rounded-[1.5rem] text-indigo-800 shadow-sm mb-4 animate-in fade-in slide-in-from-top-2">
                    <div class="flex items-center gap-3">
                        <div class="w-10 h-10 bg-white rounded-xl flex items-center justify-center text-indigo-600 shadow-sm border border-indigo-100">
                            <i data-lucide="user-check" size="20"></i>
                        </div>
                        <div>
                            <div class="flex items-center gap-2">
                                <h3 class="font-black text-sm uppercase tracking-tight">${getDisplayName(res.currentStudent)}</h3>
                                <span class="px-1.5 py-0.5 bg-green-500 text-white text-[8px] font-bold rounded uppercase">กำลังใช้งาน</span>
                            </div>
                            <p class="text-[10px] font-bold text-indigo-400 mt-0.5">
                                <i data-lucide="calendar" size="10" class="inline mb-0.5"></i> ${formatDateTH(activeBookings[0].date)} | 
                                <i data-lucide="clock" size="10" class="inline mb-0.5"></i> ${timeRange} น.
                            </p>
                        </div>
                    </div>
                </div>
            `;
        }

        function render() {
            const app = document.getElementById('app');
            let mainContent = '';

            if (window.state.view === 'public_calendar' || window.state.view === 'public_slots') {
                mainContent = renderPublicView();
            } else if (!window.state.isLoggedIn) {
                mainContent = renderLogin();
            } else {
                mainContent = `
                    ${renderHeader()}
                    <div class="scrollable-content custom-scrollbar">
                        <!-- ปรับแก้: ขยายความกว้าง Main Container จาก max-w-xl เป็น max-w-2xl -->
                        <main class="max-w-2xl mx-auto px-4 py-6">
                            ${window.state.isAdmin ? renderAdminUI() : renderUserUI()}
                        </main>
                        ${renderScrollHint()}
                    </div>
                    ${renderFooter()}
                    ${renderStickyAction()}
                `;
            }

            const loadingOverlay = window.state.isLoading ? `
                <div class="fixed inset-0 bg-slate-900/60 backdrop-blur-sm z-[9999] flex flex-col items-center justify-center p-8 text-white animate-in fade-in duration-200">
                    <div class="w-12 h-12 border-4 border-white/20 border-t-white rounded-full animate-spin mb-4"></div>
                    <p class="font-bold text-sm tracking-widest uppercase">กำลังบันทึกข้อมูล...</p>
                </div>
            ` : '';

            app.innerHTML = `
                ${mainContent}
                ${renderUIModal()}
                ${renderQRModalDisplay()}
                ${renderHistoryModal()}
                ${renderEditResourceModal()} 
                ${renderAnnouncementModal()}
                ${renderResourceSelectionModal()}
                ${renderStudentDetailModal()} <!-- NEW MODAL -->
                ${loadingOverlay}
            `;

            const container = document.querySelector('.scrollable-content');
            if (container) {
                if (window.state.shouldRestoreScroll) {
                    container.style.scrollBehavior = 'auto'; 
                    // FIXED: Removed setTimeout to prevent flickering (immediate restore)
                    container.scrollTop = window.state.lastScrollTop;
                    window.state.shouldRestoreScroll = false; 
                } else if (window.state.lastScrollTop === 0) {
                     container.scrollTop = 0;
                }
            }
            
            // Check for search input and restore focus if present (handled mostly by oninput logic now, but good for full re-renders)
            const searchInput = document.getElementById('admin-search-input');
            if (searchInput && window.state.adminSearchQuery) {
                // Focus restoring logic if needed, but handled by separate function mostly
            }

            setupScrollHint();
            lucide.createIcons();
            // Pass mode to scanner if applicable
            if (window.state.view === 'scanner') {
                 // Check if active bookings have any checked-in status to determine mode
                 const hasCheckedIn = window.state.activeBookings.some(b => b.status === 'checked_in');
                 const mode = hasCheckedIn ? 'checkout' : 'checkin';
                 setTimeout(() => initScanner(mode), 100);
            }
        }

        // ... [Standard render functions for hint, login, widgets remain the same] ...
        
        function renderScrollHint() {
            const isCalendar = window.state.view === 'calendar';
            const isSelection = !window.state.selectedResource && window.state.view !== 'login' && window.state.view !== 'scanner';
            
            if (!isCalendar && !isSelection) return '';
            
            const text = isCalendar ? 'เลื่อนลงเพื่อดูช่วงเวลา' : 'เลื่อนเพื่อดูจุดใช้งาน';

            return `
                <div id="scroll-hint" onclick="window.scrollToTarget()" class="fixed bottom-[calc(6rem+env(safe-area-inset-bottom))] left-1/2 -translate-x-1/2 bg-slate-800/70 backdrop-blur-md text-white text-[10px] font-bold px-6 py-3 rounded-full shadow-2xl opacity-0 transition-all duration-300 pointer-events-none z-30 flex items-center gap-2 border border-white/10 uppercase tracking-wider cursor-pointer hover:bg-slate-700 active:scale-95">
                    <span>${text}</span>
                    <i data-lucide="arrow-down" size="14" class="animate-bounce-slow"></i>
                </div>
            `;
        }

        function renderLogin() {
            return `
                <div class="h-[100dvh] w-full flex flex-col items-center justify-center p-6 bg-slate-50 relative overflow-hidden">
                    <div class="max-w-sm w-full bg-white rounded-[2.5rem] p-10 shadow-2xl border border-white text-center page-transition">
                        <div class="w-20 h-20 bg-indigo-600 rounded-3xl flex items-center justify-center text-white mx-auto mb-8 shadow-xl"><i data-lucide="shield-check" size="40"></i></div>
                        <h1 class="text-3xl font-black text-slate-800 mb-2">SmartBooking</h1>
                        <p class="text-slate-400 text-[10px] font-bold uppercase mt-2 tracking-widest opacity-60">${window.state.settings.projectName}</p>
                        <form onsubmit="window.handleLogin(event)" class="mt-12 space-y-5">
                            <input id="login_sid" type="text" placeholder="รหัสนักศึกษา" class="w-full p-5 rounded-2xl bg-slate-50 border-2 border-slate-100 font-bold text-lg text-center outline-none focus:border-indigo-500 shadow-inner" required>
                            <!-- ปรับขนาดปุ่มให้เล็กลงจากเดิม (py-5 -> py-3, text-lg -> text-base) -->
                            <button type="submit" class="w-full py-3 bg-indigo-600 text-white font-bold rounded-2xl shadow-xl hover:bg-indigo-700 active:scale-95 transition-all text-base border-b-4 border-indigo-900">เข้าสู่ระบบ</button>
                        </form>
                        <div class="mt-8 pt-8 border-t border-slate-100">
                            <button onclick="window.setView('public_calendar')" class="flex items-center justify-center gap-2 mx-auto text-indigo-600 font-bold text-sm hover:underline active:scale-95 transition-all">
                                <i data-lucide="calendar-search" size="18"></i> ดูตารางการใช้งานรวม
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderCalendarWidget(isInternal = false) {
            const date = window.state.calendarViewDate;
            const year = date.getFullYear();
            const month = date.getMonth();
            const firstDay = new Date(year, month, 1).getDay();
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            const maxSlots = getPossibleSlotsCount();
            const todayStr = getLocalDateString();
            
            let daysHtml = [];
            for(let i=0; i<firstDay; i++) daysHtml.push('<div class="aspect-square"></div>');
            
            const targetResId = isInternal ? window.state.selectedResource.id : window.state.publicSelectedResourceId;

            for(let d=1; d<=daysInMonth; d++) {
                const dateStr = `${year}-${(month+1).toString().padStart(2,'0')}-${d.toString().padStart(2,'0')}`;
                const isPast = dateStr < todayStr;
                const available = isServiceAvailable(dateStr);
                
                const isClosed = window.state.settings.closedDates && window.state.settings.closedDates[dateStr];
                
                // แก้ไข: ไม่กรอง completed ออก เพื่อให้นับว่าเต็ม
                const bookingsOnDay = window.state.bookings.filter(b => b.date === dateStr && b.resourceId === targetResId);
                const count = bookingsOnDay.length;
                const isFull = count >= maxSlots;
                const isSelected = window.state.selectedDate === dateStr;

                let borderClass = 'border-slate-50';
                if (available) {
                    if (isClosed) borderClass = 'border-orange-200 bg-orange-50 text-orange-400';
                    else if (isFull) borderClass = 'border-red-500 bg-red-50';
                    else if (count > 0) borderClass = 'border-green-500 bg-green-50';
                }

                daysHtml.push(`
                    <button onclick="${available ? `window.saveScrollPosition(); window.state.selectedSlots=[]; window.state.selectedDate='${dateStr}'; ${isInternal ? 'window.render()' : "window.setView('public_slots')"}` : ''}" 
                            class="aspect-square flex flex-col items-center justify-center rounded-xl transition-all border-2 ${isSelected && isInternal ? 'ring-4 ring-indigo-200 z-10' : ''} 
                            ${available ? `bg-white ${borderClass} hover:border-indigo-400 active:scale-90 shadow-sm` : 'bg-slate-50 border-transparent text-slate-300 cursor-not-allowed'}
                            ${isPast ? 'opacity-40 grayscale-[0.5]' : ''}">
                        <span class="text-sm font-bold ${available && !isClosed ? 'text-slate-800' : isClosed ? 'text-orange-500' : ''}">${d}</span>
                        ${available && !isClosed && count > 0 && !isFull ? `<div class="mt-1 w-1 h-1 bg-green-500 rounded-full"></div>` : ''}
                        ${available && !isClosed && isFull ? `<div class="mt-1 w-1 h-1 bg-red-500 rounded-full"></div>` : ''}
                        ${isClosed ? `<div class="mt-1 w-1 h-1 bg-orange-500 rounded-full"></div>` : ''}
                    </button>
                `);
            }

            return `
                <div class="bg-white rounded-[2.5rem] p-6 shadow-xl border border-white">
                    <div class="flex items-center justify-between mb-6 px-2">
                        <button onclick="window.saveScrollPosition(); window.state.calendarViewDate.setMonth(window.state.calendarViewDate.getMonth()-1); window.render();" class="p-2 hover:bg-slate-100 rounded-lg text-indigo-600"><i data-lucide="chevron-left" size="20"></i></button>
                        <div class="text-center">
                            <h3 class="font-black text-slate-800 text-base leading-none">${MONTHS_TH[month]} ${year + 543}</h3>
                        </div>
                        <button onclick="window.saveScrollPosition(); window.state.calendarViewDate.setMonth(window.state.calendarViewDate.getMonth()+1); window.render();" class="p-2 hover:bg-slate-100 rounded-lg text-indigo-600"><i data-lucide="chevron-right" size="20"></i></button>
                    </div>
                    <div class="calendar-grid">
                        ${DAYS_TH.map(d => `<div class="text-center text-[10px] font-black text-slate-400 uppercase py-2">${d}</div>`).join('')}
                        ${daysHtml.join('')}
                    </div>
                    <div class="mt-6 flex flex-wrap justify-center gap-4 pt-4 border-t border-slate-50">
                        <div class="flex items-center gap-2 text-[8px] font-bold text-slate-400 uppercase tracking-wider"><div class="w-3 h-3 bg-white border border-slate-200 rounded"></div> ว่าง</div>
                        <div class="flex items-center gap-2 text-[8px] font-bold text-slate-400 uppercase tracking-wider"><div class="w-3 h-3 bg-green-50 border border-green-500 rounded"></div> มีคนจองแล้ว</div>
                        <div class="flex items-center gap-2 text-[8px] font-bold text-slate-400 uppercase tracking-wider"><div class="w-3 h-3 bg-red-50 border border-red-500 rounded"></div> เต็มแล้ว</div>
                        <div class="flex items-center gap-2 text-[8px] font-bold text-slate-400 uppercase tracking-wider"><div class="w-3 h-3 bg-orange-50 border border-orange-500 rounded"></div> ปิด</div>
                    </div>
                </div>
            `;
        }
        
        // ... [Public view functions remain same] ...
        
        function renderPublicView() {
            if (window.state.view === 'public_slots') return renderPublicSlots();
            
            const activeUserCard = window.state.publicSelectedResourceId 
                ? renderActiveUserCard(window.state.publicSelectedResourceId, true) 
                : '';

            return `
                <div class="flex-1 flex flex-col bg-slate-50 overflow-hidden page-transition">
                    <header class="p-6 bg-white border-b border-slate-200 flex items-center justify-between safe-pt h-auto min-h-16">
                        <button onclick="window.setView('login')" class="p-3 bg-slate-100 rounded-xl active:scale-90"><i data-lucide="chevron-left"></i></button>
                        <h2 class="font-black text-slate-800 text-lg uppercase tracking-tight">ตารางการใช้งานรวม</h2>
                        <div class="w-10"></div>
                    </header>
                    <div class="scrollable-content p-6">
                        <div class="max-w-md mx-auto space-y-6">
                            ${window.state.resources.length > 1 ? `
                                <div class="mb-4 p-1 bg-slate-200 rounded-2xl flex gap-1">
                                    ${window.state.resources.map(r => `
                                        <button onclick="window.state.publicSelectedResourceId='${r.id}'; window.render();" 
                                                class="flex-1 py-2 text-[10px] font-black uppercase rounded-xl transition-all ${window.state.publicSelectedResourceId === r.id ? 'bg-white text-indigo-600 shadow-sm' : 'text-slate-500'}">
                                            ${r.name}
                                        </button>
                                    `).join('')}
                                </div>
                            ` : ''}
                            
                            ${activeUserCard}

                            ${renderCalendarWidget(false)}
                        </div>
                    </div>
                </div>
            `;
        }

        function renderPublicSlots() {
            const dateStr = window.state.selectedDate;
            const todayStr = getLocalDateString(); 
            const isPastDate = dateStr < todayStr;
            const isClosedDate = window.state.settings.closedDates && window.state.settings.closedDates[dateStr];

            const slots = [];
            let current = new Date(`2000-01-01T${window.state.settings.startTime}`);
            let endLimit = new Date(`2000-01-01T${window.state.settings.endTime}`);
            while (current < endLimit) {
                let start = current.toTimeString().substring(0, 5);
                let next = new Date(current.getTime() + 60 * 60 * 1000);
                if (next > endLimit) next = endLimit;
                slots.push({ start, end: next.toTimeString().substring(0, 5) });
                current.setHours(current.getHours() + 1);
            }
            const res = window.state.resources.find(r => r.id === window.state.publicSelectedResourceId);
            const resBookings = window.state.bookings.filter(b => b.date === dateStr && b.resourceId === res.id);
            
            const activeUserCard = renderActiveUserCard(window.state.publicSelectedResourceId);

            return `
                <div class="flex-1 flex flex-col bg-slate-50 overflow-hidden page-transition text-left">
                    <header class="p-6 bg-white border-b border-slate-200 flex items-center justify-between safe-pt h-auto min-h-16">
                        <button onclick="window.setView('public_calendar')" class="p-3 bg-slate-100 rounded-xl active:scale-90"><i data-lucide="chevron-left"></i></button>
                        <h2 class="font-black text-slate-800 text-lg uppercase">${res.name} / ${formatDateTH(dateStr)}</h2>
                        <div class="w-10"></div>
                    </header>
                    <div class="scrollable-content p-6 space-y-4">
                        <div class="max-w-md mx-auto space-y-3">
                            ${activeUserCard}
                        
                            ${isClosedDate ? `
                                <div class="p-8 bg-orange-50 rounded-[2.5rem] text-center border-2 border-dashed border-orange-200 space-y-2">
                                    <div class="w-12 h-12 bg-orange-100 text-orange-500 rounded-full flex items-center justify-center mx-auto mb-2"><i data-lucide="alert-circle" size="24"></i></div>
                                    <p class="font-black text-orange-600 text-lg uppercase leading-none">วันนี้ปิดให้บริการ</p>
                                    <p class="text-[10px] font-bold text-orange-400 uppercase tracking-widest">Reason: ${window.state.settings.closedDates[dateStr]}</p>
                                </div>
                            ` : `
                                ${isPastDate ? `<div class="bg-red-50 p-4 rounded-2xl border border-red-100 text-red-500 font-bold text-[10px] uppercase text-center mb-4">วันและเวลาที่ผ่านมาแล้ว ไม่สามารถทำการจองใหม่ได้</div>` : ''}
                                ${slots.map(s => {
                                    const b = resBookings.find(x => x.slot === s.start);
                                    if (b) {
                                        if (b.status === 'completed') {
                                            return `
                                                <div class="p-5 bg-slate-100 rounded-[2rem] border border-slate-200 flex justify-between items-center opacity-80">
                                                    <div class="text-left">
                                                        <p class="text-sm font-black text-slate-500 leading-none">${s.start} - ${s.end}</p>
                                                        <p class="text-[10px] font-bold text-slate-400 uppercase mt-2 tracking-widest">ใช้งานเสร็จสิ้น (${getDisplayName(b.studentId)})</p>
                                                        <p class="text-[8px] text-slate-400 font-medium mt-1 uppercase">เวลาจอง: ${formatDateTime(b.createdAt)}</p>
                                                    </div>
                                                    <div class="w-10 h-10 bg-slate-200 text-slate-400 rounded-full flex items-center justify-center"><i data-lucide="check-circle" size="18"></i></div>
                                                </div>
                                            `;
                                        }
                                        return `
                                            <div class="p-5 bg-white rounded-[2rem] border border-slate-100 flex justify-between items-center shadow-sm">
                                                <div class="text-left">
                                                    <p class="text-sm font-black text-slate-800 leading-none">${s.start} - ${s.end}</p>
                                                    <p class="text-[10px] font-bold text-red-500 uppercase mt-2 tracking-widest">ไม่ว่าง: ${getDisplayName(b.studentId)}</p>
                                                    <p class="text-[8px] text-slate-400 font-medium mt-1 uppercase">เวลาจอง: ${formatDateTime(b.createdAt)}</p>
                                                </div>
                                                <div class="w-10 h-10 bg-red-50 text-red-500 rounded-full flex items-center justify-center"><i data-lucide="lock" size="18"></i></div>
                                            </div>
                                        `;
                                    } else if (isPastDate) {
                                        return `
                                            <div class="p-5 bg-slate-50 rounded-[2rem] border border-slate-200 flex justify-between items-center opacity-40">
                                                <div class="text-left">
                                                    <p class="text-sm font-black text-slate-400 leading-none">${s.start} - ${s.end}</p>
                                                    <p class="text-[9px] font-bold text-slate-400 uppercase mt-2 tracking-widest">เลยกำหนดในการจอง</p>
                                                </div>
                                                <div class="w-10 h-10 bg-slate-100 text-slate-300 rounded-full flex items-center justify-center"><i data-lucide="slash" size="18"></i></div>
                                            </div>
                                        `;
                                    } else {
                                        return `
                                            <button onclick="window.uiConfirm('จองจุดนี้?', 'เวลานี้ว่าง! ต้องการเข้าสู่ระบบเพื่อทำการจองใช่หรือไม่?', () => { window.setView('login'); })" 
                                                    class="w-full p-5 bg-white rounded-[2rem] border-2 border-dashed border-slate-200 flex justify-between items-center hover:border-indigo-400 active:scale-95 transition-all group">
                                                <div class="text-left">
                                                    <p class="text-sm font-black text-slate-400 group-hover:text-indigo-600 leading-none">${s.start} - ${s.end}</p>
                                                    <p class="text-[9px] font-bold text-green-500 uppercase mt-2 tracking-widest">ว่าง (คลิกเพื่อจอง)</p>
                                                </div>
                                                <div class="w-10 h-10 bg-slate-50 text-slate-300 group-hover:bg-indigo-50 group-hover:text-indigo-600 rounded-full flex items-center justify-center transition-all group-active:scale-90"><i data-lucide="plus" size="18"></i></div>
                                            </button>
                                        `;
                                    }
                                }).join('')}
                            `}
                        </div>
                    </div>
                </div>
            `;
        }
        
        // ... [User Calendar UI, Header, Menu remain same] ...

        function renderCalendarUI() {
            const hStart = window.state.settings.startTime;
            const hEnd = window.state.settings.endTime;
            const todayStr = getLocalDateString();
            const isPastDate = window.state.selectedDate < todayStr;
            const isClosedDate = window.state.settings.closedDates && window.state.settings.closedDates[window.state.selectedDate];

            const slots = [];
            let current = new Date(`2000-01-01T${hStart}`);
            let endLimit = new Date(`2000-01-01T${hEnd}`);
            while (current < endLimit) {
                let start = current.toTimeString().substring(0, 5);
                let next = new Date(current.getTime() + 60 * 60 * 1000);
                if (next > endLimit) next = endLimit;
                slots.push({ start, end: next.toTimeString().substring(0, 5) });
                current.setHours(current.getHours() + 1);
            }
            
            const myToday = window.state.bookings.filter(b => b.studentId === window.state.studentId && b.date === window.state.selectedDate && b.resourceId === window.state.selectedResource.id);
            const bookedDaily = window.state.bookings.filter(b => b.studentId === window.state.studentId && b.date === window.state.selectedDate).length;
            const bookedTotal = window.state.bookings.filter(b => b.studentId === window.state.studentId).length;

            return `
                <div class="space-y-6 page-transition text-left">
                    <button onclick="window.setView('selection'); window.state.selectedResource=null; window.render();" class="flex items-center gap-2 text-slate-400 hover:text-indigo-600 text-[10px] font-bold uppercase tracking-widest"><i data-lucide="arrow-left" size="14"></i> เปลี่ยนจุดใช้งาน</button>
                    
                    <div class="bg-indigo-600 p-6 rounded-[2.5rem] text-white shadow-xl flex items-center gap-4">
                         <div class="w-12 h-12 bg-white/20 rounded-2xl flex items-center justify-center flex-shrink-0"><i data-lucide="box" size="24"></i></div>
                         <div class="text-left overflow-hidden">
                            <h2 class="text-xl font-black leading-normal uppercase truncate pt-1">${window.state.selectedResource.name}</h2>
                            <p class="text-[10px] font-medium text-indigo-100 mt-0 opacity-90 truncate">${window.state.selectedResource.description || 'ไม่มีคำอธิบาย'}</p>
                         </div>
                    </div>

                    ${renderCalendarWidget(true)}
                    
                    <div class="space-y-4">
                        <div id="quota-container" class="grid grid-cols-2 gap-3 scroll-mt-24">
                            <div class="bg-indigo-600 p-4 rounded-2xl text-white shadow-lg text-left leading-none">
                                <p class="text-[8px] font-bold uppercase opacity-60 mb-1 tracking-wider">โควตาวันนี้</p>
                                <p class="text-2xl font-black">${bookedDaily + window.state.selectedSlots.length} / ${window.state.settings.maxHoursPerDay} <span class="text-[10px] opacity-50">ชม.</span></p>
                            </div>
                            <div class="bg-slate-900 p-4 rounded-2xl text-white shadow-lg text-left leading-none">
                                <p class="text-[8px] font-bold uppercase opacity-60 mb-1 tracking-wider">โควตาทั้งหมด</p>
                                <p class="text-2xl font-black">${bookedTotal + window.state.selectedSlots.length} / ${window.state.settings.maxTotalHours} <span class="text-[10px] opacity-50">ชม.</span></p>
                            </div>
                        </div>

                        ${myToday.length > 0 ? `
                            <button onclick="window.viewPassToday()" 
                                    class="w-full p-5 bg-emerald-50 border-2 border-emerald-400 text-emerald-700 font-black rounded-[2rem] shadow-sm active:scale-[0.98] transition-all flex items-center justify-between gap-3 text-[10px] uppercase tracking-widest hover:bg-emerald-100">
                                <div class="flex items-center gap-3"><i data-lucide="ticket" size="18"></i> <span>ดูใบยืนยันการจอง</span></div>
                                <i data-lucide="chevron-right" size="18"></i>
                            </button>
                        ` : ''}

                        ${renderActiveUserCard(window.state.selectedResource.id)}

                        <div class="flex justify-between items-center px-2 pt-2">
                            <p class="text-[10px] font-black text-slate-400 uppercase tracking-widest">สถานะวันที่ ${formatDateTH(window.state.selectedDate)}</p>
                        </div>

                        ${isClosedDate ? `
                            <div class="p-8 bg-orange-50 rounded-[2.5rem] text-center border-2 border-dashed border-orange-200 space-y-2">
                                <div class="w-12 h-12 bg-orange-100 text-orange-500 rounded-full flex items-center justify-center mx-auto mb-2"><i data-lucide="alert-circle" size="24"></i></div>
                                <p class="font-black text-orange-600 text-lg uppercase leading-none">วันนี้ปิดให้บริการ</p>
                                <p class="text-[10px] font-bold text-orange-400 uppercase tracking-widest">Reason: ${window.state.settings.closedDates[window.state.selectedDate]}</p>
                            </div>
                        ` : !isServiceAvailable(window.state.selectedDate) ? `<div class="p-12 bg-orange-50 rounded-[2.5rem] text-center border-2 border-dashed border-orange-200 font-bold text-orange-700 text-sm uppercase">ไม่เปิดให้บริการในวันนี้</div>` : `
                            <div id="slots-container" class="grid grid-cols-1 gap-2.5">
                                ${slots.map(s => {
                                    const bOthers = window.state.bookings.find(b => b.date === window.state.selectedDate && b.slot === s.start && b.resourceId === window.state.selectedResource.id && b.studentId !== window.state.studentId);
                                    const bMine = window.state.bookings.find(b => b.date === window.state.selectedDate && b.slot === s.start && b.resourceId === window.state.selectedResource.id && b.studentId === window.state.studentId);
                                    const isSelecting = window.state.selectedSlots.some(sel => sel.start === s.start);
                                    
                                    let btnClass = "bg-white border-slate-100 text-slate-500 hover:border-indigo-300";
                                    let sText = "ว่าง"; 
                                    let act = `window.toggleSlotSelection(${JSON.stringify(s).replace(/"/g, '&quot;')})`;
                                    let icon = '<i data-lucide="plus" size="16" class="opacity-20"></i>';
                                    
                                    if (bOthers) { 
                                        if (bOthers.status === 'completed') {
                                            btnClass = "bg-slate-100 border-slate-200 text-slate-400 cursor-not-allowed"; 
                                            sText = `ใช้งานเสร็จสิ้น (${getDisplayName(bOthers.studentId)})`; 
                                            act = ""; 
                                            icon = '<i data-lucide="check-circle" size="14"></i>';
                                        } else {
                                            btnClass = "bg-red-50 border-red-200 text-red-500 shadow-sm opacity-90 cursor-not-allowed"; 
                                            sText = `ไม่ว่าง (โดย: ${getDisplayName(bOthers.studentId)})`; 
                                            act = ""; 
                                            icon = '<i data-lucide="lock" size="14"></i>';
                                        }
                                    } else if (bMine) { 
                                        if (bMine.status === 'completed') {
                                            btnClass = "bg-slate-50 border-slate-200 text-slate-400 cursor-not-allowed";
                                            sText = `ใช้งานเสร็จสิ้น (${getDisplayName(bMine.studentId)})`;
                                            act = ""; 
                                            icon = '<i data-lucide="check-circle" size="16"></i>';
                                        } else if (bMine.status === 'checked_in') {
                                            btnClass = "bg-indigo-50 border-indigo-500 text-indigo-700 shadow-sm cursor-not-allowed"; 
                                            sText = "เช็คอินแล้ว"; 
                                            act = "window.uiAlert('ไม่สามารถยกเลิกรายการที่เช็คอินแล้วได้', 'error')"; 
                                            icon = '<i data-lucide="user-check" size="16"></i>';
                                        } else if (!window.state.isAdmin && window.state.selectedDate === todayStr) {
                                            btnClass = "bg-green-50 border-green-500 text-green-700 shadow-sm cursor-not-allowed"; 
                                            sText = "จองแล้ว (ยกเลิกไม่ได้)"; 
                                            act = "window.uiAlert('ไม่สามารถยกเลิกการจองในวันใช้งานได้ (ต้องล่วงหน้า 1 วัน)', 'error')"; 
                                            icon = '<i data-lucide="lock" size="16"></i>';
                                        } else {
                                            btnClass = "bg-green-50 border-green-500 text-green-700 shadow-sm"; 
                                            sText = "จองแล้ว (คลิกยกเลิก)"; 
                                            act = `window.delBooking('${bMine.id}')`; 
                                            icon = '<i data-lucide="check" size="16"></i>';
                                        }
                                    } else if (isSelecting) { 
                                        btnClass = "bg-indigo-600 border-indigo-600 text-white shadow-xl ring-4 ring-indigo-50 transform scale-[1.02] z-10"; 
                                        sText = "กำลังเลือก"; 
                                        icon = '<i data-lucide="check" size="16"></i>';
                                    } else if (isPastDate) {
                                        btnClass = "bg-slate-50 border-slate-100 text-slate-300 cursor-not-allowed opacity-40";
                                        sText = "เลยกำหนดในการจอง";
                                        act = "";
                                        icon = '<i data-lucide="slash" size="14"></i>';
                                    }
                                    
                                    return `
                                        <button onclick="${act}" class="relative p-5 rounded-2xl border-2 transition-all flex justify-between items-center ${btnClass} active:scale-[0.98] text-left">
                                            <div class="leading-none">
                                                <span class="text-base font-bold">${s.start} - ${s.end}</span>
                                                <p class="text-[8px] font-bold uppercase mt-1.5 opacity-80 tracking-widest">${sText}</p>
                                            </div>
                                            <div class="w-8 h-8 rounded-xl flex items-center justify-center ${bMine || isSelecting ? 'bg-white/20' : 'bg-slate-50'} shadow-inner">
                                                ${icon}
                                            </div>
                                        </button>
                                    `;
                                }).join('')}
                            </div>
                        `}
                    </div>
                </div>
            `;
        }

        function renderHeader() {
            return `
                <header class="bg-white border-b border-slate-100 flex-none px-6 z-50 shadow-sm flex items-center justify-between safe-pt h-auto min-h-16">
                    <div class="max-w-2xl mx-auto w-full flex items-center justify-between">
                        <div class="flex items-center gap-3 cursor-pointer" onclick="window.setView('selection'); window.state.selectedResource=null; window.render();">
                            <div class="w-10 h-10 bg-indigo-600 rounded-xl flex items-center justify-center text-white shadow-lg"><i data-lucide="layers" size="20"></i></div>
                            <div class="text-left leading-none">
                                <h1 class="font-black text-base text-slate-800 uppercase">Smart</h1>
                                <p class="text-[8px] font-bold text-indigo-600 uppercase tracking-widest mt-1">${window.state.settings.projectName}</p>
                            </div>
                        </div>
                        <div class="flex items-center gap-2">
                             <!-- NEW: Info/Announcement Button -->
                            <button onclick="window.state.showAnnouncementModal = true; window.render()" class="p-3 bg-indigo-50 text-indigo-500 hover:text-indigo-600 rounded-xl border border-indigo-100 active:scale-90 transition-all"><i data-lucide="info" size="18"></i></button>
                            <button onclick="window.logout()" class="p-3 bg-slate-50 text-slate-400 hover:text-red-500 rounded-xl border border-slate-100 active:scale-90 transition-all"><i data-lucide="power" size="18"></i></button>
                        </div>
                    </div>
                </header>
            `;
        }

        function renderUserUI() {
            if (window.state.view === 'scanner') return renderScannerUI();
            if (window.state.view === 'pass') return renderReceiptUI();
            if (!window.state.selectedResource) return renderResourceMenu();
            return renderCalendarUI();
        }

        function renderResourceMenu() {
            // แก้ไข: นับรวม completed ด้วย
            const bookedTotal = window.state.bookings.filter(b => b.studentId === window.state.studentId).length;
            
            const myBookings = window.state.bookings
                .filter(b => b.studentId === window.state.studentId)
                .sort((a, b) => (b.createdAt?.seconds || 0) - (a.createdAt?.seconds || 0));

            const dateSummary = {};
            myBookings.forEach(b => {
                 dateSummary[b.date] = (dateSummary[b.date] || 0) + 1;
            });
            const sortedSummaryDates = Object.keys(dateSummary).sort(); 
            const isSystemOpen = window.state.settings.systemStatus !== false; 

            return `
                <div class="space-y-6 page-transition text-left pb-12">
                    <div class="bg-indigo-600 p-4 rounded-[2rem] text-white shadow-xl relative overflow-hidden h-auto transition-all">
                         <div class="absolute -right-10 -top-10 w-40 h-40 bg-white/10 rounded-full blur-3xl pointer-events-none"></div>
                         
                         <div class="flex justify-between items-start mb-1">
                             <p class="text-[9px] font-bold uppercase tracking-widest opacity-60">Authenticated ID</p>
                             <div class="flex items-center gap-1.5 bg-white/10 px-2 py-1 rounded-full border border-white/10">
                                <div class="w-1.5 h-1.5 bg-green-400 rounded-full animate-pulse"></div>
                                <span class="text-[8px] font-bold text-indigo-100 uppercase tracking-widest">Connected</span>
                            </div>
                         </div>

                         <h2 class="text-2xl font-black tracking-tighter leading-none mb-3">${getDisplayName(window.state.studentId)}</h2>

                         <div class="grid grid-cols-2 gap-3 items-stretch">
                             <div class="bg-indigo-900/40 p-3 rounded-2xl flex flex-col justify-start min-h-[5rem]">
                                 <p class="text-[9px] font-bold text-indigo-300 uppercase tracking-widest mb-1">โควตาทั้งหมด</p>
                                  <div class="flex items-baseline gap-1">
                                     <span class="text-2xl font-black leading-none">${bookedTotal}</span>
                                     <span class="text-[10px] opacity-50">/ ${window.state.settings.maxTotalHours} ชม.</span>
                                 </div>
                             </div>

                             <button onclick="window.openHistoryModal()" class="bg-indigo-900/40 p-3 rounded-2xl flex flex-col justify-start min-h-[5rem] relative text-left w-full hover:bg-indigo-900/60 transition-colors">
                                 <p class="text-[9px] font-bold text-indigo-300 uppercase tracking-widest mb-1">รายการจอง</p>
                                 <div class="space-y-1 w-full overflow-hidden">
                                    ${sortedSummaryDates.length === 0 ? 
                                        '<div class="text-[10px] opacity-40 mt-1">- ว่าง -</div>' : 
                                        sortedSummaryDates.map(d => `
                                            <div class="w-full flex justify-between items-center text-[10px] font-medium leading-none text-indigo-50/80 hover:bg-white/10 rounded px-1 py-0.5 transition-colors">
                                                <span>${formatDateShortTH(d)}</span>
                                                <span class="font-bold bg-white/10 px-1.5 py-0.5 rounded text-[9px]">${dateSummary[d]} ชม.</span>
                                            </div>
                                        `).join('')
                                    }
                                 </div>
                             </button>
                         </div>
                    </div>
                    
                    ${!isSystemOpen ? `
                        <div class="bg-red-50 p-6 rounded-[2rem] border-2 border-red-100 shadow-sm text-center animate-pulse">
                            <div class="w-12 h-12 bg-red-100 text-red-500 rounded-full flex items-center justify-center mx-auto mb-3">
                                <i data-lucide="power-off" size="24"></i>
                            </div>
                            <h3 class="text-red-600 font-black text-lg uppercase">ระบบปิดให้บริการชั่วคราว</h3>
                            <p class="text-red-400 text-[10px] font-bold uppercase tracking-widest mt-1">ขออภัยในความไม่สะดวก</p>
                        </div>
                    ` : `
                        <div class="bg-white p-6 rounded-[2rem] border border-slate-100 shadow-sm space-y-3">
                            <div class="flex items-center justify-between">
                                <span class="text-[10px] font-bold text-slate-400 uppercase tracking-widest">ระยะเวลาโครงการ</span>
                                <span class="text-xs font-bold text-slate-800">${formatDateTH(window.state.settings.startDate)} - ${formatDateTH(window.state.settings.endDate)}</span>
                            </div>
                            <div class="flex items-center justify-between">
                                <span class="text-[10px] font-bold text-slate-400 uppercase tracking-widest">เวลาทำการ</span>
                                <span class="text-xs font-bold text-slate-800">${window.state.settings.startTime} - ${window.state.settings.endTime} น.</span>
                            </div>
                             <div class="flex items-center justify-between">
                                <span class="text-[10px] font-bold text-slate-400 uppercase tracking-widest">วันให้บริการ</span>
                                <div class="flex gap-1">
                                    ${window.state.settings.availableDays.map(d => `<span class="h-5 px-1.5 rounded-full bg-indigo-50 text-indigo-600 flex items-center justify-center text-[8px] font-bold">${DAYS_TH[d]}</span>`).join('')}
                                </div>
                            </div>
                        </div>
                    `}

                    <div id="resource-list" class="grid grid-cols-1 gap-4">
                        <div class="text-[10px] font-bold text-slate-400 uppercase tracking-widest px-2 leading-none">เลือกทรัพยากรเพื่อดำเนินการจอง</div>
                        ${window.state.resources.map(res => `
                            <button onclick="window.selectResource('${res.id}')" class="group bg-white p-6 rounded-[2rem] border border-slate-100 shadow-sm hover:shadow-lg hover:border-indigo-200 transition-all text-left flex items-center justify-between active:scale-[0.99] ${res.status === 'in_use' ? 'opacity-90' : ''} ${!isSystemOpen ? 'opacity-50 pointer-events-none grayscale' : ''}">
                                <div class="flex items-center gap-5 overflow-hidden">
                                    <div class="w-12 h-12 rounded-2xl flex items-center justify-center transition-all flex-shrink-0 ${res.status === 'in_use' ? 'bg-orange-50 text-orange-500' : 'bg-slate-50 text-slate-400 group-hover:bg-indigo-600 group-hover:text-white'}">
                                        <i data-lucide="map-pin" size="22"></i>
                                    </div>
                                    <div class="text-left overflow-hidden">
                                        <h3 class="font-bold text-base text-slate-800 leading-normal truncate pt-1">${res.name}</h3>
                                        <!-- Added Description Here -->
                                        ${res.description ? `<p class="text-[10px] text-slate-500 mt-1 truncate font-medium">${res.description}</p>` : ''}
                                        <div class="flex items-center gap-2 mt-2 leading-none">
                                            <div class="w-2 h-2 rounded-full ${res.status === 'in_use' ? 'bg-orange-400 animate-pulse' : 'bg-green-400'}"></div>
                                            <span class="text-[9px] font-bold uppercase tracking-widest ${res.status === 'in_use' ? 'text-orange-500' : 'text-green-500'}">
                                                ${res.status === 'in_use' ? `In Use by ${res.currentStudent}` : 'พร้อมใช้งาน'}
                                            </span>
                                        </div>
                                    </div>
                                </div>
                                <i data-lucide="chevron-right" size="20" class="text-slate-200 group-hover:text-indigo-600 transition-all flex-shrink-0"></i>
                            </button>
                        `).join('')}
                    </div>
                </div>
            `;
        }

        // --- UPDATED: Squeezed Receipt UI & Check-out Logic ---
        function renderReceiptUI() {
            // ใช้ activeBookings ที่อัปเดตสถานะแล้ว
            const booking = window.state.activeBookings[0];
            const bookingDate = booking ? booking.date : '';
            const todayStr = getLocalDateString();
            const isToday = bookingDate === todayStr;

            const systemEndTime = window.state.settings.endTime || "23:59";
            
            const now = new Date();
            const currentHm = now.getHours().toString().padStart(2,'0') + ':' + now.getMinutes().toString().padStart(2,'0');
            const isTimeOver = currentHm > systemEndTime;

            // Check Booking Status (สถานะล่าสุดจาก Memory)
            const isCheckedIn = booking?.status === 'checked_in';
            const isCompleted = booking?.status === 'completed';

            // Timestamps (จาก Memory)
            const checkInTime = booking?.checkInAt ? formatTimeOnly(booking.checkInAt) : '-';
            const checkOutTime = booking?.checkOutAt ? formatTimeOnly(booking.checkOutAt) : '-';

            return `
                <div class="max-w-xs mx-auto animate-in zoom-in duration-300 page-transition">
                    <div class="bg-white rounded-[2.5rem] overflow-hidden shadow-2xl border border-slate-100 relative">
                        <!-- Compact Header -->
                        <div class="bg-indigo-600 p-5 text-white text-center relative overflow-hidden">
                             <div class="absolute -right-4 -top-4 w-20 h-20 bg-white/10 rounded-full blur-xl"></div>
                            <i data-lucide="ticket" size="32" class="mx-auto mb-2 opacity-40"></i>
                            <h2 class="text-xl font-black mb-0 tracking-tight leading-none uppercase">
                                ${isCompleted ? 'การใช้งานเสร็จสิ้น' : 'ใบจองสำเร็จ'}
                            </h2>
                        </div>
                        
                        <!-- Compact Body -->
                        <div class="p-5 space-y-3 ticket-cutout text-center leading-tight">
                            <div>
                                <p class="text-[8px] font-bold text-slate-400 uppercase mb-1">Resource</p>
                                <p class="text-lg font-black text-slate-800 uppercase leading-none">${window.state.activeBookings[0]?.resourceName}</p>
                            </div>
                            
                            <div class="bg-slate-50 p-4 rounded-xl border-2 border-dashed border-slate-200">
                                <p class="text-[8px] font-bold text-slate-400 uppercase mb-1">Approved Time</p>
                                <p class="text-indigo-600 font-black text-sm">${window.formatBookingRanges(window.state.activeBookings)}</p>
                                <p class="text-[10px] text-slate-400 font-bold mt-2 border-t border-slate-200 pt-2">วันที่: ${formatDateTH(bookingDate)}</p>
                                
                                <div class="flex justify-between items-center mt-2 pt-2 border-t border-slate-200 text-[9px] font-bold text-slate-500 uppercase tracking-tight">
                                    <div class="flex flex-col items-start">
                                        <span class="text-slate-300">In</span>
                                        <span class="${checkInTime!=='-' ? 'text-green-500':''}">${checkInTime}</span>
                                    </div>
                                    <div class="flex flex-col items-end">
                                        <span class="text-slate-300">Out</span>
                                        <span class="${checkOutTime!=='-' ? 'text-slate-800':''}">${checkOutTime}</span>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="pt-2 flex flex-col gap-2">
                                ${isCompleted ? `
                                    <button disabled class="w-full py-3 bg-slate-100 text-slate-400 font-bold rounded-xl cursor-not-allowed flex items-center justify-center gap-2 opacity-80 border border-slate-200">
                                        <i data-lucide="check-circle" size="18"></i> เรียบร้อยแล้ว
                                    </button>
                                ` : isToday ? (
                                    !isTimeOver ? (
                                        isCheckedIn ? `
                                            <button onclick="window.requestCameraPermission('checkout')" class="w-full py-3 bg-orange-500 text-white font-bold rounded-xl shadow-lg hover:bg-orange-600 active:scale-95 transition-all flex items-center justify-center gap-2 border-b-4 border-orange-700">
                                                <i data-lucide="log-out" size="18"></i> สแกนเช็คเอาท์
                                            </button>
                                        ` : `
                                            <button onclick="window.requestCameraPermission('checkin')" class="w-full py-3 bg-slate-900 text-white font-bold rounded-xl shadow-lg active:scale-95 transition-all flex items-center justify-center gap-2 border-b-4 border-slate-700">
                                                <i data-lucide="qr-code" size="18"></i> สแกนเช็คอิน
                                            </button>
                                        `
                                    ) : `
                                        <button disabled class="w-full py-3 bg-slate-100 text-red-400 font-bold rounded-xl cursor-not-allowed flex items-center justify-center gap-2 opacity-80">
                                            <i data-lucide="clock" size="18"></i> หมดเวลาเข้าใช้งาน
                                        </button>
                                    `
                                ) : `
                                    <button disabled class="w-full py-3 bg-slate-100 text-slate-400 font-bold rounded-xl cursor-not-allowed flex items-center justify-center gap-2 opacity-80">
                                        <i data-lucide="calendar-off" size="18"></i> เช็คอินได้เฉพาะวันที่จอง
                                    </button>
                                `}
                                <!-- FIXED: Use goHome() helper to ensure clean state reset especially after scanning -->
                                <button onclick="window.goHome()" class="text-[9px] font-bold text-slate-400 uppercase tracking-widest py-2 hover:text-indigo-500 transition-colors">กลับหน้าหลัก</button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderScannerUI() {
            // Determine text based on mode
            const booking = window.state.activeBookings[0];
            const isCheckout = booking?.status === 'checked_in';
            const actionText = isCheckout ? "เช็คเอาท์ (Check-out)" : "เช็คอิน (Check-in)";
            const colorClass = isCheckout ? "text-orange-400" : "text-white";

            return `
                <div class="fixed inset-0 bg-slate-900 z-[100] flex flex-col items-center justify-center p-8 text-white">
                    <h2 class="text-2xl font-black mb-1 text-center ${colorClass}">${actionText}</h2>
                    <p class="text-[10px] font-bold uppercase tracking-widest opacity-60 mb-4">Scan QR Code at the Resource</p>
                    <div class="relative w-full max-w-sm aspect-square bg-black rounded-[3rem] overflow-hidden border-8 border-white/5 my-4 shadow-2xl">
                        <div id="reader"></div>
                        <div class="absolute inset-0 pointer-events-none border-[3rem] border-slate-900/40 z-10"></div>
                        <div class="absolute top-1/2 left-0 right-0 h-1.5 ${isCheckout ? 'bg-orange-500 shadow-[0_0_30px_#f97316]' : 'bg-indigo-500 shadow-[0_0_30px_#6366f1]'} animate-scan-line z-20"></div>
                    </div>
                    <button onclick="window.setView('pass')" class="w-full max-w-sm py-4 bg-red-500/10 text-red-400 font-bold rounded-2xl border border-red-500/20 text-[10px] uppercase tracking-widest">ยกเลิก</button>
                </div>
            `;
        }

        function renderAdminUI() {
            const activeDates = [...new Set(window.state.bookings.map(b => b.date))].sort();
            const closedDates = window.state.settings.closedDates || {};
            const searchValue = window.state.adminSearchQuery || '';
            
            return `
                <div class="space-y-8 page-transition pb-32 text-left relative">
                    <!-- NEW: ADMIN BADGE -->
                    <div class="fixed top-[calc(4rem+env(safe-area-inset-top))] left-1/2 -translate-x-1/2 z-40">
                        <div class="bg-slate-900 text-white text-[8px] font-black px-4 py-1 rounded-b-xl shadow-lg border-x border-b border-slate-800 uppercase tracking-[0.2em] flex items-center gap-2">
                            <div class="w-1.5 h-1.5 bg-red-500 rounded-full animate-pulse"></div>
                            Admin Mode Active
                        </div>
                    </div>

                    <!-- SYSTEM STATUS TOGGLE -->
                    <section class="bg-indigo-600 p-8 rounded-[2.5rem] shadow-xl space-y-6 text-white relative overflow-hidden mt-6">
                        <div class="absolute -right-10 -top-10 w-40 h-40 bg-white/10 rounded-full blur-3xl pointer-events-none"></div>
                        <div class="flex justify-between items-center relative z-10">
                            <div>
                                <h2 class="text-xl font-black flex items-center gap-3"><i data-lucide="power" class="text-white/70"></i> System Status</h2>
                                <p class="text-[10px] font-bold uppercase tracking-widest opacity-60 mt-1">
                                    สถานะระบบ: ${window.state.settings.systemStatus ? 'เปิดให้บริการ' : 'ปิดปรับปรุงชั่วคราว'}
                                </p>
                            </div>
                            <button onclick="window.toggleSystemStatus()" class="w-16 h-8 rounded-full transition-all flex items-center px-1 ${window.state.settings.systemStatus ? 'bg-green-400 justify-end' : 'bg-slate-800 justify-start'}">
                                <div class="w-6 h-6 bg-white rounded-full shadow-md"></div>
                            </button>
                        </div>
                    </section>
                    
                    <!-- NEW SEARCH SECTION -->
                    <section class="bg-white p-6 rounded-[2.5rem] shadow-xl border border-slate-100 space-y-4">
                        <h2 class="text-xl font-black text-slate-800 flex items-center gap-3"><i data-lucide="search" class="text-indigo-600"></i> ค้นหาข้อมูลนักศึกษา</h2>
                        <div class="relative">
                            <input type="text" id="admin-search-input" value="${searchValue}" oninput="window.handleAdminSearch(event)" placeholder="พิมพ์รหัสนักศึกษา (เช่น 65...)" class="w-full p-4 pl-12 rounded-2xl bg-slate-50 border-2 border-slate-100 font-bold text-lg outline-none focus:border-indigo-500 shadow-inner transition-all">
                            <i data-lucide="search" class="absolute left-4 top-1/2 -translate-y-1/2 text-slate-400"></i>
                        </div>
                        <div id="admin-search-results" class="space-y-2 max-h-[300px] overflow-y-auto custom-scrollbar">
                            <!-- Results will be injected here via JS -->
                            ${searchValue.length > 0 ? '' : '<p class="text-center text-slate-300 text-xs py-4">พิมพ์อย่างน้อย 2 ตัวอักษรเพื่อค้นหา</p>'}
                        </div>
                    </section>
                    
                    <!-- Announcement Settings -->
                    <section class="bg-white p-8 rounded-[2.5rem] border border-slate-100 shadow-xl space-y-4 text-left">
                         <h2 class="text-xl font-black text-slate-800 flex items-center gap-3 text-left leading-none"><i data-lucide="megaphone" class="text-indigo-600"></i> ประกาศ / วิธีใช้งาน</h2>
                         <form onsubmit="window.saveAnnouncement(event)" class="space-y-3">
                            <textarea name="announcement" placeholder="พิมพ์ประกาศ หรือ วิธีการใช้งานที่นี่..." class="w-full h-32 p-4 rounded-2xl bg-slate-50 border-2 border-slate-100 font-medium text-sm outline-none focus:border-indigo-500 transition-all custom-scrollbar resize-none">${window.state.settings.announcement || ''}</textarea>
                            <button type="submit" class="w-full py-3 bg-indigo-600 text-white font-bold rounded-xl shadow-lg active:scale-95 transition-all text-xs uppercase tracking-widest">บันทึกประกาศ</button>
                         </form>
                    </section>

                    <!-- SPECIAL DATES MANAGEMENT -->
                    <section class="bg-white p-8 rounded-[2.5rem] border border-slate-100 shadow-xl space-y-6 text-left">
                        <h2 class="text-xl font-black text-slate-800 flex items-center gap-3 text-left leading-none"><i data-lucide="calendar-off" class="text-indigo-600"></i> Special Holidays</h2>
                        <form onsubmit="window.addClosedDate(event)" class="space-y-3">
                            <div class="grid grid-cols-2 gap-3">
                                <input name="date" type="date" class="p-3 rounded-xl bg-slate-50 border border-slate-200 text-sm font-bold" required>
                                <input name="reason" type="text" placeholder="ระบุสาเหตุการปิด..." class="p-3 rounded-xl bg-slate-50 border border-slate-200 text-sm font-bold" required>
                            </div>
                            <button type="submit" class="w-full py-3 bg-orange-500 text-white font-bold rounded-xl shadow-lg active:scale-95 transition-all text-xs uppercase">เพิ่มวันหยุดพิเศษ</button>
                        </form>
                        <div class="space-y-2">
                            ${Object.keys(closedDates).length === 0 ? '<p class="text-center text-slate-300 text-xs py-4">ไม่มีวันหยุดพิเศษ</p>' : 
                                Object.entries(closedDates).sort().map(([date, reason]) => `
                                    <div class="flex justify-between items-center p-3 bg-orange-50 rounded-xl border border-orange-100">
                                        <div>
                                            <p class="text-xs font-black text-slate-700">${formatDateTH(date)}</p>
                                            <p class="text-[9px] font-bold text-orange-500 uppercase tracking-wide">${reason}</p>
                                        </div>
                                        <button onclick="window.removeClosedDate('${date}')" class="p-2 text-red-400 hover:bg-red-50 rounded-lg transition-all"><i data-lucide="trash-2" size="14"></i></button>
                                    </div>
                                `).join('')
                            }
                        </div>
                    </section>
                    
                    <section class="bg-slate-900 p-8 rounded-[2.5rem] shadow-xl space-y-6">
                        <div class="flex justify-between items-center">
                            <h2 class="text-xl font-black text-white flex items-center gap-3"><i data-lucide="users-round" class="text-indigo-400"></i> Student Whitelist</h2>
                            <button onclick="window.state.whitelistLocked = !window.state.whitelistLocked; window.render();" class="p-3 ${window.state.whitelistLocked ? 'bg-red-500/20 text-red-400' : 'bg-green-500/20 text-green-400'} rounded-xl transition-all">
                                <i data-lucide="${window.state.whitelistLocked ? 'lock' : 'unlock'}" size="18"></i>
                            </button>
                        </div>
                        <p class="text-indigo-300 text-[10px] font-bold uppercase tracking-widest opacity-70">วางรายชื่อที่ Copy จาก Excel ได้เลย (ระบบจะดึงเฉพาะรหัสนักศึกษาโดยอัตโนมัติ)</p>
                        <form onsubmit="window.saveWhitelist(event)" class="space-y-4">
                            <textarea name="studentsList" ${window.state.whitelistLocked ? 'readonly' : ''} placeholder="วางรหัสนักศึกษาที่นี่..." 
                                    class="w-full h-40 p-5 rounded-2xl bg-white/5 border-2 border-white/10 text-white font-mono text-xs outline-none focus:border-indigo-500 transition-all custom-scrollbar 
                                    ${window.state.whitelistLocked ? 'opacity-60 cursor-not-allowed overflow-hidden select-none pointer-events-none' : ''}">${window.state.allowedStudents.join('\n')}</textarea>
                            <button type="submit" ${window.state.whitelistLocked ? 'disabled' : ''} class="w-full py-5 bg-indigo-500 text-white font-black rounded-2xl shadow-xl hover:bg-indigo-600 active:scale-95 transition-all text-xs uppercase tracking-widest border-b-4 border-indigo-800 disabled:opacity-50">อัปเดต (${window.state.allowedStudents.length})</button>
                        </form>
                    </section>
                    
                    <section class="bg-white p-8 rounded-[2.5rem] border border-slate-100 shadow-xl space-y-6 text-left">
                        <h2 class="text-xl font-black text-slate-800 flex items-center gap-3 text-left leading-none"><i data-lucide="settings-2" class="text-indigo-600"></i> Project Settings</h2>
                        <form onsubmit="window.saveSettings(event)" class="grid grid-cols-1 md:grid-cols-2 gap-6 leading-none text-left">
                            <div class="md:col-span-2 space-y-2 text-left"><label class="text-[10px] font-bold uppercase text-slate-400 ml-3 text-left">Project Name</label><input name="projectName" type="text" value="${window.state.settings.projectName}" class="w-full p-4 rounded-2xl bg-slate-50 border-2 border-slate-100 font-bold outline-none focus:border-indigo-500 shadow-inner text-left" required></div>
                            <div class="space-y-2 text-left"><label class="text-[10px] font-bold uppercase text-slate-400 ml-3 text-left">Start Date</label><input name="startDate" type="date" value="${window.state.settings.startDate}" class="w-full p-4 rounded-2xl bg-slate-50 border-2 border-slate-100 font-bold text-sm text-center"></div>
                            <div class="space-y-2 text-left"><label class="text-[10px] font-bold uppercase text-slate-400 ml-3 text-left">End Date</label><input name="endDate" type="date" value="${window.state.settings.endDate}" class="w-full p-4 rounded-2xl bg-slate-50 border-2 border-slate-100 font-bold text-sm text-center"></div>
                            <div class="space-y-2 text-left"><label class="text-[10px] font-bold uppercase text-slate-400 ml-3 text-left">Open</label><input name="startTime" type="time" value="${window.state.settings.startTime}" class="w-full p-4 rounded-2xl bg-slate-50 border-2 border-slate-100 font-bold text-center"></div>
                            <div class="space-y-2 text-left"><label class="text-[10px] font-bold uppercase text-slate-400 ml-3 text-left">Close</label><input name="endTime" type="time" value="${window.state.settings.endTime}" class="w-full p-4 rounded-2xl bg-slate-50 border-2 border-slate-100 font-bold text-center"></div>
                            <div class="md:col-span-2 space-y-3 text-left"><label class="text-[10px] font-bold uppercase text-slate-400 ml-3 text-left">Service Days</label><div class="flex flex-wrap gap-2 text-left">${DAYS_TH.map((d, i) => `<label class="flex items-center gap-3 bg-slate-50 px-4 py-3 rounded-2xl border-2 border-slate-100 text-[10px] font-bold cursor-pointer hover:bg-indigo-50 text-center"><input type="checkbox" name="day-${i}" ${window.state.settings.availableDays.includes(i) ? 'checked' : ''} class="w-5 h-5 rounded text-indigo-600 text-center"> <span class="text-left">${d}</span></label>`).join('')}</div></div>
                            <div class="space-y-2 text-left"><label class="text-[10px] font-bold uppercase text-slate-400 ml-3 text-left">Limit/Day (Hr)</label><input name="maxHoursDay" type="number" value="${window.state.settings.maxHoursPerDay}" class="w-full p-4 rounded-2xl bg-indigo-50 border-2 border-indigo-100 font-black text-indigo-600 text-left"></div>
                            <div class="space-y-2 text-left"><label class="text-[10px] font-bold uppercase text-slate-400 ml-3 text-left">Total Limit (Hr)</label><input name="maxHoursTotal" type="number" value="${window.state.settings.maxTotalHours}" class="w-full p-4 rounded-2xl bg-indigo-50 border-2 border-indigo-100 font-black text-indigo-600 text-left"></div>
                            <button type="submit" class="md:col-span-2 py-5 bg-indigo-600 text-white font-black rounded-2xl shadow-xl hover:bg-indigo-700 active:scale-95 transition-all uppercase text-xs tracking-widest border-b-8 border-indigo-900 mt-4 text-center">บันทึกโครงสร้างระบบ</button>
                        </form>
                    </section>
                    
                    <section class="bg-white p-8 rounded-[2.5rem] border border-slate-100 shadow-xl space-y-6 text-left">
                        <h2 class="text-xl font-black text-slate-800 flex items-center gap-3 text-left leading-none"><i data-lucide="box" class="text-indigo-600"></i> Manage Resources</h2>
                        
                        <!-- Modified Form with Description -->
                        <form onsubmit="window.addRes(event)" class="grid grid-cols-1 md:grid-cols-2 gap-3 text-left">
                            <div class="md:col-span-2 flex gap-3">
                                <input name="resName" placeholder="ระบุชื่อจุดใช้งาน..." class="flex-1 p-4 rounded-2xl bg-slate-50 border-2 border-slate-100 font-bold text-sm outline-none shadow-inner text-left" required>
                            </div>
                            <div class="md:col-span-2 flex gap-3">
                                <input name="resDesc" placeholder="คำอธิบาย (เช่น ชั้น 2, มีโปรเจคเตอร์)" class="flex-1 p-4 rounded-2xl bg-slate-50 border-2 border-slate-100 font-medium text-sm outline-none shadow-inner text-left">
                                <button type="submit" class="px-8 bg-slate-900 text-white font-bold rounded-2xl text-[10px] uppercase shadow-lg text-center flex-none">เพิ่ม</button>
                            </div>
                        </form>

                        <div class="grid grid-cols-1 gap-3 text-left">
                            ${window.state.resources.map((res, index) => `
                                <div class="flex justify-between items-center p-4 bg-slate-50 rounded-2xl border border-slate-100 text-left">
                                    <div class="flex items-center gap-3 text-left overflow-hidden">
                                        <div class="flex flex-col gap-1 mr-2 flex-shrink-0">
                                            <button onclick="window.moveResource('${res.id}', 'up')" class="p-1 text-slate-300 hover:text-indigo-600 disabled:opacity-30 transition-all" ${index === 0 ? 'disabled' : ''}><i data-lucide="chevron-up" size="14"></i></button>
                                            <button onclick="window.moveResource('${res.id}', 'down')" class="p-1 text-slate-300 hover:text-indigo-600 disabled:opacity-30 transition-all" ${index === window.state.resources.length - 1 ? 'disabled' : ''}><i data-lucide="chevron-down" size="14"></i></button>
                                        </div>
                                        <div class="w-10 h-10 bg-white rounded-xl flex items-center justify-center text-slate-300 border border-slate-100 text-center flex-shrink-0"><i data-lucide="box" size="20"></i></div>
                                        <div class="text-left overflow-hidden">
                                            <p class="font-black text-slate-800 text-sm leading-none text-left truncate">${res.name}</p>
                                            <!-- Added Description Display -->
                                            ${res.description ? `<p class="text-[10px] text-slate-500 mt-1 truncate font-medium">${res.description}</p>` : ''}
                                            <p class="text-[8px] text-slate-400 font-bold uppercase mt-1 text-left">UID: ${res.id.substring(0,6)}...</p>
                                        </div>
                                    </div>
                                    <div class="flex gap-1 text-left shrink-0">
                                        <!-- Changed Edit Action -->
                                        <button onclick="window.openEditResourceModal('${res.id}')" class="p-2 bg-white text-slate-400 hover:text-indigo-600 rounded-xl shadow-md border border-slate-100 active:scale-90 text-center"><i data-lucide="pencil" size="16"></i></button>
                                        <button onclick="window.openQRModal('${res.id}', '${res.name}')" class="p-2 bg-white text-indigo-600 rounded-xl shadow-md border border-slate-100 active:scale-90 text-center"><i data-lucide="qr-code" size="16"></i></button>
                                        <button onclick="window.deleteResource('${res.id}')" class="p-2 bg-white text-red-400 rounded-xl shadow-md border border-slate-100 active:scale-90 text-center"><i data-lucide="trash-2" size="16"></i></button>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </section>

                    <section class="bg-white p-8 rounded-[2.5rem] border border-slate-100 shadow-xl space-y-6 text-left overflow-hidden">
                        <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4 text-left leading-none">
                            <h2 class="text-xl font-black text-slate-800 flex items-center gap-3 text-left leading-none text-left"> <i data-lucide="history" class="text-indigo-600"></i> History & Clearing</h2>
                            <button onclick="window.clearAllHistory()" class="px-5 py-2.5 bg-red-50 text-red-500 text-[10px] font-bold uppercase rounded-xl border border-red-100 hover:bg-red-100 text-center leading-none text-center">ล้างประวัติทั้งหมด</button>
                        </div>
                        <div class="bg-slate-50 p-5 rounded-3xl space-y-3 text-left">
                            <p class="text-[9px] font-bold text-slate-400 uppercase tracking-widest text-left">ลบประวัติรายวันอัจฉริยะ (เลือกวันที่ต้องการลบ)</p>
                            <div class="flex flex-wrap gap-2 text-left">
                                ${activeDates.length > 0 ? activeDates.map(d => `<button onclick="window.clearByDay('${d}')" class="px-3 py-2 bg-white text-[10px] font-bold text-indigo-600 rounded-xl border border-indigo-100 shadow-sm hover:border-red-400 hover:text-red-500 transition-all active:scale-95 text-center flex items-center gap-2 text-center"><i data-lucide="calendar" size="12"></i> ${formatDateTH(d)}</button>`).join('') : '<p class="text-[10px] text-slate-300 font-bold text-left leading-none">ยังไม่มีประวัติการจอง</p>'}
                            </div>
                        </div>
                        <div class="overflow-x-auto custom-scrollbar text-left text-left">
                            <table class="w-full text-left border-collapse text-left text-left">
                                <thead class="border-b border-slate-100 text-[9px] font-bold uppercase text-slate-400 text-left">
                                    <tr><th class="py-5 text-left">SCHEDULE</th><th class="py-5 text-left">IDENTIFIER</th><th class="py-5 text-center text-center">STATUS</th><th class="py-5 text-right"></th></tr>
                                </thead>
                                <tbody class="divide-y divide-slate-50 text-left">
                                    ${window.state.bookings.slice().sort((a,b) => (b.createdAt?.seconds || 0) - (a.createdAt?.seconds || 0)).map(b => `
                                        <tr class="group hover:bg-slate-50/50 text-left">
                                            <td class="py-5 text-left text-left">
                                                <p class="font-black text-slate-800 text-[12px] text-left">${formatDateTH(b.date)}</p>
                                                <p class="text-[9px] text-indigo-600 font-bold mt-1 uppercase text-left leading-none">${b.slot}-${b.slot_end?.split(':')[1] || '59'}</p>
                                            </td>
                                            <td class="py-5 text-left text-left">
                                                <p class="text-slate-800 font-black text-[12px] truncate max-w-[140px] text-left leading-none">${getDisplayName(b.studentId)}</p>
                                                <p class="text-[8px] text-slate-400 font-bold uppercase mt-1 truncate max-w-[100px] text-left leading-none">${b.resourceName}</p>
                                            </td>
                                            <td class="py-5 text-center text-center">
                                                ${b.status === 'checked_in' ? `<span class="px-2.5 py-1 bg-green-100 text-green-600 text-[8px] font-bold rounded-full uppercase border border-green-200 text-center">Arrived</span>` : 
                                                  b.status === 'completed' ? `<span class="px-2.5 py-1 bg-slate-100 text-slate-400 text-[8px] font-bold rounded-full uppercase border border-slate-200 text-center">Done</span>` :
                                                  `<span class="px-2.5 py-1 bg-slate-100 text-slate-400 text-[8px] font-bold rounded-full uppercase border border-slate-200 opacity-60 text-center">Waiting</span>`}
                                            </td>
                                            <td class="py-5 text-right text-right">
                                                <button onclick="window.delBooking('${b.id}')" class="p-2 text-slate-200 hover:text-red-500 opacity-0 group-hover:opacity-100 transition-all text-center"><i data-lucide="trash-2" size="18"></i></button>
                                            </td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    </section>
                </div>
            `;
        }

        function renderStickyAction() {
            if (window.state.view === 'calendar' && window.state.selectedSlots.length > 0) {
                // FIXED: Changed z-index from z-40 to z-[60]
                return `
                    <div class="fixed bottom-[calc(6rem+env(safe-area-inset-bottom))] left-0 right-0 px-6 z-[60] max-w-xl mx-auto animate-in slide-in-from-bottom-20 flex flex-col items-center">
                        <button onclick="window.confirmBookingAction()" class="w-full max-w-sm py-3 bg-indigo-600 text-white font-black rounded-full shadow-2xl transition-all active:scale-95 text-sm flex items-center justify-center gap-3 border-b-4 border-indigo-900 hover:brightness-110 text-center">
                            <i data-lucide="lock-keyhole" size="18"></i>
                            ยืนยันจอง ${window.state.selectedSlots.length} ช่วงเวลา
                        </button>
                    </div>
                `;
            }
            return "";
        }

        function renderFooter() {
            return `
                <footer class="flex-none bg-white border-t border-slate-100 py-2 px-8 z-50 shadow-inner safe-pb h-auto">
                    <div class="max-w-2xl mx-auto flex justify-between items-center text-[10px] font-bold text-slate-400 uppercase tracking-widest leading-none">
                        <div class="flex items-center gap-4 border-r pr-8 border-slate-100 text-left">
                            <div class="w-10 h-10 rounded-2xl bg-slate-50 flex items-center justify-center text-indigo-400 shadow-inner text-center"><i data-lucide="fingerprint" size="18"></i></div>
                            <div class="text-left"><p class="text-[7px] opacity-40 mb-1 leading-none uppercase">Session</p><p class="text-slate-800 leading-none font-black text-xs uppercase">${getDisplayName(window.state.studentId) || 'Logged Out'}</p></div>
                        </div>
                        <div class="flex items-center gap-3 text-green-500 bg-green-50/50 px-5 py-2.5 rounded-xl border border-green-100 text-center">
                            <div class="w-2 h-2 rounded-full bg-green-500 animate-pulse"></div> 
                            <span class="font-black text-[9px] uppercase">Cloud Service</span>
                        </div>
                    </div>
                </footer>
            `;
        }
        
        // --- NEW: Student Detail Modal (Detailed Version) ---
        function renderStudentDetailModal() {
            if (!window.state.viewingStudentId) return "";
            
            const id = window.state.viewingStudentId;
            const name = getDisplayName(id);
            // Sort history new to old
            const history = window.state.bookings.filter(b => b.studentId === id).sort((a,b) => (b.createdAt?.seconds || 0) - (a.createdAt?.seconds || 0));
            
            const total = history.length;
            const completed = history.filter(b => b.status === 'completed').length;
            const active = history.filter(b => b.status === 'checked_in').length;
            
            // Calculate No-Show (Past date + status is 'booked')
            const todayStr = getLocalDateString();
            const noShow = history.filter(b => b.status === 'booked' && b.date < todayStr).length;
            const pending = history.filter(b => b.status === 'booked' && b.date >= todayStr).length;

            // Most used resource
            const resCounts = {};
            history.forEach(b => { resCounts[b.resourceName] = (resCounts[b.resourceName] || 0) + 1; });
            const favRes = Object.entries(resCounts).sort((a,b) => b[1] - a[1])[0];
            const favResName = favRes ? favRes[0] : '-';

            return `
                <div class="fixed inset-0 bg-slate-900/90 backdrop-blur-md z-[9999] flex items-center justify-center p-6 page-transition">
                    <div class="bg-white rounded-[2.5rem] w-full max-w-lg shadow-2xl border border-white relative flex flex-col max-h-[90vh] overflow-hidden">
                        
                        <!-- Admin Badge in Modal -->
                        <div class="bg-slate-800 text-white text-[9px] font-black text-center py-1.5 uppercase tracking-[0.2em]">
                            Administrator View
                        </div>

                        <!-- Header -->
                        <div class="p-6 border-b border-slate-100 flex items-center justify-between bg-slate-50">
                            <div class="flex items-center gap-4">
                                <div class="w-14 h-14 bg-gradient-to-br from-indigo-500 to-indigo-700 text-white rounded-2xl flex items-center justify-center shadow-lg shadow-indigo-200">
                                    <i data-lucide="user" size="28"></i>
                                </div>
                                <div>
                                    <h3 class="text-xl font-black text-slate-800 leading-none tracking-tight">${name}</h3>
                                    <p class="text-xs text-slate-400 font-bold uppercase mt-1.5 flex items-center gap-1">
                                        <i data-lucide="fingerprint" size="12"></i> ID: ${id}
                                    </p>
                                </div>
                            </div>
                            <button onclick="window.closeStudentDetail()" class="w-10 h-10 bg-white text-slate-800 rounded-xl shadow-sm flex items-center justify-center border border-slate-200 active:scale-90 transition-transform hover:bg-red-50 hover:text-red-500 hover:border-red-100"><i data-lucide="x" size="20"></i></button>
                        </div>
                        
                        <div class="p-6 overflow-y-auto custom-scrollbar bg-slate-50/50">
                            <!-- Deep Stats Grid -->
                            <h4 class="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-3 px-1">Performance Overview</h4>
                            <div class="grid grid-cols-2 gap-3 mb-6">
                                <div class="p-4 bg-white rounded-2xl border border-slate-100 shadow-sm flex items-center justify-between">
                                    <div>
                                        <p class="text-[9px] font-bold text-slate-400 uppercase tracking-wide">Total Bookings</p>
                                        <p class="text-2xl font-black text-slate-800 mt-0.5">${total}</p>
                                    </div>
                                    <div class="w-10 h-10 rounded-full bg-slate-50 flex items-center justify-center text-slate-400"><i data-lucide="layers" size="18"></i></div>
                                </div>
                                <div class="p-4 bg-white rounded-2xl border border-slate-100 shadow-sm flex items-center justify-between">
                                    <div>
                                        <p class="text-[9px] font-bold text-green-500 uppercase tracking-wide">Success Rate</p>
                                        <p class="text-2xl font-black text-green-600 mt-0.5">${total > 0 ? Math.round((completed/total)*100) : 0}%</p>
                                    </div>
                                    <div class="w-10 h-10 rounded-full bg-green-50 flex items-center justify-center text-green-500"><i data-lucide="activity" size="18"></i></div>
                                </div>
                                <div class="p-4 bg-white rounded-2xl border border-slate-100 shadow-sm flex items-center justify-between">
                                    <div>
                                        <p class="text-[9px] font-bold text-indigo-500 uppercase tracking-wide">Active/Pending</p>
                                        <p class="text-2xl font-black text-indigo-600 mt-0.5">${active + pending}</p>
                                    </div>
                                    <div class="w-10 h-10 rounded-full bg-indigo-50 flex items-center justify-center text-indigo-500"><i data-lucide="clock" size="18"></i></div>
                                </div>
                                <div class="p-4 bg-white rounded-2xl border border-slate-100 shadow-sm flex items-center justify-between">
                                    <div>
                                        <p class="text-[9px] font-bold text-red-400 uppercase tracking-wide">No-Show/Missed</p>
                                        <p class="text-2xl font-black text-red-500 mt-0.5">${noShow}</p>
                                    </div>
                                    <div class="w-10 h-10 rounded-full bg-red-50 flex items-center justify-center text-red-400"><i data-lucide="alert-circle" size="18"></i></div>
                                </div>
                            </div>

                            <div class="mb-6 p-4 bg-white rounded-2xl border border-slate-100 shadow-sm">
                                <p class="text-[9px] font-bold text-slate-400 uppercase tracking-wide mb-2">Favorite Resource</p>
                                <div class="flex items-center gap-3">
                                    <div class="w-8 h-8 bg-orange-50 text-orange-500 rounded-lg flex items-center justify-center"><i data-lucide="star" size="16"></i></div>
                                    <p class="font-bold text-slate-700 text-sm">${favResName}</p>
                                </div>
                            </div>
                            
                            <!-- History Table -->
                             <h4 class="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-3 px-1 flex justify-between items-center">
                                <span>Detailed History</span>
                                <span class="bg-slate-200 text-slate-500 px-2 py-0.5 rounded text-[8px]">${history.length} ITEMS</span>
                             </h4>
                             <div class="space-y-3">
                                ${history.length === 0 ? '<div class="p-10 text-center text-slate-300 text-xs bg-white rounded-3xl border-2 border-dashed border-slate-100">ไม่พบประวัติการจอง</div>' : 
                                    history.map(b => {
                                        const statusMap = {
                                            'completed': { color: 'bg-slate-100 text-slate-500 border-slate-200', icon: 'check-circle', label: 'Completed' },
                                            'checked_in': { color: 'bg-green-50 text-green-600 border-green-100', icon: 'play-circle', label: 'In Progress' },
                                            'booked': { color: 'bg-indigo-50 text-indigo-600 border-indigo-100', icon: 'calendar-clock', label: 'Scheduled' }
                                        };
                                        // Override for No-show
                                        let st = statusMap[b.status] || { color: 'bg-gray-100', icon: 'help-circle', label: b.status };
                                        if (b.status === 'booked' && b.date < todayStr) {
                                            st = { color: 'bg-red-50 text-red-500 border-red-100', icon: 'x-circle', label: 'No Show' };
                                        }

                                        return `
                                        <div class="bg-white p-4 border border-slate-100 rounded-2xl hover:border-indigo-200 hover:shadow-md transition-all group relative overflow-hidden">
                                            <div class="absolute top-0 right-0 p-3 opacity-10 group-hover:opacity-100 transition-opacity">
                                                <button onclick="window.delBooking('${b.id}')" class="text-slate-300 hover:text-red-500"><i data-lucide="trash-2" size="16"></i></button>
                                            </div>
                                            <div class="flex justify-between items-start mb-3 pr-6">
                                                <div>
                                                    <p class="text-xs font-black text-slate-800 mb-1">${b.resourceName}</p>
                                                    <div class="flex items-center gap-2">
                                                        <span class="px-2 py-1 rounded-md text-[8px] font-bold uppercase tracking-wider border ${st.color} flex items-center gap-1">
                                                            <i data-lucide="${st.icon}" size="10"></i> ${st.label}
                                                        </span>
                                                    </div>
                                                </div>
                                                <div class="text-right">
                                                    <p class="text-[10px] font-bold text-slate-600 bg-slate-50 px-2 py-1 rounded-lg border border-slate-100">${formatDateTH(b.date)}</p>
                                                </div>
                                            </div>
                                            
                                            <div class="grid grid-cols-2 gap-2 text-[10px] bg-slate-50/50 p-3 rounded-xl border border-slate-50">
                                                <div>
                                                    <p class="text-[8px] text-slate-400 font-bold uppercase mb-0.5">Time Slot</p>
                                                    <p class="font-bold text-indigo-600">${b.slot} - ${b.slot_end || addMinutes(b.slot, 59)}</p>
                                                </div>
                                                <div>
                                                    <p class="text-[8px] text-slate-400 font-bold uppercase mb-0.5">Created At</p>
                                                    <p class="font-medium text-slate-500">${formatDateTime(b.createdAt)}</p>
                                                </div>
                                                ${b.checkInAt ? `
                                                <div class="col-span-2 flex items-center gap-4 mt-1 pt-2 border-t border-slate-100">
                                                    <div class="flex items-center gap-1.5">
                                                        <div class="w-1.5 h-1.5 rounded-full bg-green-500"></div>
                                                        <span class="text-slate-500 font-medium">In: <b class="text-slate-700">${formatTimeOnly(b.checkInAt)}</b></span>
                                                    </div>
                                                    ${b.checkOutAt ? `
                                                    <div class="flex items-center gap-1.5">
                                                        <div class="w-1.5 h-1.5 rounded-full bg-slate-400"></div>
                                                        <span class="text-slate-500 font-medium">Out: <b class="text-slate-700">${formatTimeOnly(b.checkOutAt)}</b></span>
                                                    </div>` : ''}
                                                </div>
                                                ` : ''}
                                            </div>
                                        </div>
                                    `}).join('')
                                }
                             </div>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderQRModalDisplay() {
            if (!window.state.showQRModal) return "";
            return `
                <div class="fixed inset-0 bg-slate-900/90 backdrop-blur-md z-[9999] flex items-center justify-center p-6 page-transition">
                    <div class="bg-white rounded-[3rem] p-10 max-w-sm w-full text-center relative shadow-2xl animate-in zoom-in duration-300 border-t-8 border-indigo-600">
                        <button onclick="window.closeQRModal()" class="absolute -top-4 -right-4 w-12 h-12 bg-white text-slate-800 rounded-2xl shadow-xl flex items-center justify-center border-2 border-slate-50 active:scale-75 transition-transform text-center"><i data-lucide="x" size="24"></i></button>
                        <h3 class="text-2xl font-black mb-1 text-slate-800 tracking-tight uppercase text-center">${window.state.showQRModal.name}</h3>
                        <div class="bg-slate-50 p-8 rounded-[2.5rem] mb-10 flex items-center justify-center border-2 border-slate-100 shadow-inner text-center">
                            <img src="https://api.qrserver.com/v1/create-qr-code/?size=300x300&data=${window.state.showQRModal.id}" alt="QR" class="w-full h-auto rounded-3xl shadow-xl">
                        </div>
                        <button onclick="window.print()" class="w-full py-5 bg-indigo-600 text-white font-black rounded-2xl shadow-xl hover:bg-indigo-700 transition-all flex items-center justify-center gap-4 active:scale-95 text-xs uppercase tracking-widest text-center"><i data-lucide="printer" size="20"></i> พิมพ์ติดตั้ง</button>
                    </div>
                </div>
            `;
        }
        
        // --- NEW: Edit Resource Modal ---
        function renderEditResourceModal() {
            if (!window.state.editingResource) return "";
            return `
                <div class="fixed inset-0 bg-slate-900/80 backdrop-blur-sm z-[9999] flex items-center justify-center p-8 page-transition">
                    <div class="bg-white rounded-[2.5rem] p-10 max-w-sm w-full text-center shadow-2xl border border-white relative animate-in zoom-in duration-200">
                        <button onclick="window.closeEditResourceModal()" class="absolute -top-3 -right-3 w-10 h-10 bg-white text-slate-800 rounded-full shadow-lg flex items-center justify-center border border-slate-100 active:scale-90 transition-transform"><i data-lucide="x" size="20"></i></button>
                        
                        <div class="w-14 h-14 bg-indigo-50 text-indigo-600 rounded-2xl flex items-center justify-center mx-auto mb-4 shadow-sm">
                            <i data-lucide="pencil" size="28"></i>
                        </div>
                        <h3 class="text-lg font-black text-slate-800 mb-6 leading-tight">แก้ไขข้อมูลทรัพยากร</h3>
                        
                        <form onsubmit="window.saveEditResource(event)" class="space-y-4 text-left">
                            <div class="space-y-2">
                                <label class="text-[10px] font-bold text-slate-400 uppercase tracking-widest ml-1">ชื่อจุดใช้งาน</label>
                                <input name="editResName" type="text" value="${window.state.editingResource.name}" class="w-full p-4 rounded-2xl bg-slate-50 border-2 border-slate-100 font-bold text-sm outline-none focus:border-indigo-500 shadow-inner" required>
                            </div>
                            <div class="space-y-2">
                                <label class="text-[10px] font-bold text-slate-400 uppercase tracking-widest ml-1">คำอธิบาย</label>
                                <input name="editResDesc" type="text" value="${window.state.editingResource.description || ''}" class="w-full p-4 rounded-2xl bg-slate-50 border-2 border-slate-100 font-medium text-sm outline-none focus:border-indigo-500 shadow-inner">
                            </div>
                            <button type="submit" class="w-full py-4 bg-indigo-600 text-white font-bold rounded-2xl shadow-lg border-b-4 border-indigo-900 mt-4 active:scale-95 transition-all">บันทึกการแก้ไข</button>
                        </form>
                    </div>
                </div>
            `;
        }
        
        // --- NEW: Announcement Modal ---
        function renderAnnouncementModal() {
            if (!window.state.showAnnouncementModal) return "";
            const text = window.state.settings.announcement || "ยินดีต้อนรับสู่ระบบจองใช้งานทรัพยากร\nกรุณาปฏิบัติตามกฎระเบียบอย่างเคร่งครัด";
            
            return `
                <div class="fixed inset-0 bg-slate-900/80 backdrop-blur-sm z-[9999] flex items-center justify-center p-4 page-transition"> <!-- Reduced outer padding from p-8 to p-4 -->
                    <!-- Reduced inner padding from p-10 to p-6 -->
                    <div class="bg-white rounded-[2.5rem] p-6 max-w-lg w-full text-center shadow-2xl border border-white relative animate-in zoom-in duration-200">
                        <div class="w-16 h-16 bg-indigo-50 text-indigo-600 rounded-3xl flex items-center justify-center mx-auto mb-4 shadow-sm border border-indigo-100"> <!-- Reduced margin bottom mb-6 to mb-4 -->
                            <i data-lucide="info" size="32"></i>
                        </div>
                        <h3 class="text-xl font-black text-slate-800 mb-2 leading-tight">ประกาศ / วิธีใช้งาน</h3>
                        <!-- Reduced inner content padding from p-6 to p-4 -->
                        <div class="bg-slate-50 p-4 rounded-2xl border border-slate-100 mb-4 text-left max-h-[50vh] overflow-y-auto custom-scrollbar">
                            <p class="text-sm text-slate-600 font-medium leading-relaxed whitespace-pre-line break-words">${text}</p>
                        </div>
                        <button onclick="window.state.showAnnouncementModal = false; window.render()" class="w-full py-3 bg-indigo-600 text-white font-bold rounded-2xl shadow-lg border-b-4 border-indigo-900 active:scale-95 transition-all">รับทราบ</button>
                    </div>
                </div>
            `;
        }
        
        // --- NEW: Resource Selection Modal (For conflict dates) ---
        function renderResourceSelectionModal() {
            if (!window.state.showResourceSelectModal) return "";
            
            return `
                <div class="fixed inset-0 bg-slate-900/80 backdrop-blur-sm z-[9999] flex items-center justify-center p-8 page-transition">
                    <!-- ปรับแก้: ขยายความกว้าง Modal เล็กน้อยเป็น max-w-md -->
                    <div class="bg-white rounded-[2.5rem] p-8 max-w-md w-full text-center shadow-2xl border border-white relative animate-in zoom-in duration-200">
                        <button onclick="window.state.showResourceSelectModal = false; window.render()" class="absolute -top-3 -right-3 w-10 h-10 bg-white text-slate-800 rounded-full shadow-lg flex items-center justify-center border border-slate-100 active:scale-90 transition-transform"><i data-lucide="x" size="20"></i></button>
                        
                        <div class="w-14 h-14 bg-indigo-50 text-indigo-600 rounded-2xl flex items-center justify-center mx-auto mb-4 shadow-sm">
                            <i data-lucide="layers" size="28"></i>
                        </div>
                        <h3 class="text-lg font-black text-slate-800 mb-1 leading-tight">เลือกจุดใช้งาน</h3>
                        <p class="text-[10px] text-slate-400 font-bold uppercase tracking-widest mb-6">คุณมีการจองหลายจุดในวันที่ ${formatDateTH(window.state.resourceSelectDate)}</p>
                        
                        <div class="space-y-3 max-h-[40vh] overflow-y-auto custom-scrollbar pr-1">
                            ${window.state.resourceSelectOptions.map(r => `
                                <button onclick="window.selectResourceFromDate('${r.id}')" class="w-full p-4 bg-slate-50 border border-slate-200 rounded-2xl hover:bg-indigo-50 hover:border-indigo-200 hover:text-indigo-700 transition-all active:scale-[0.98] group flex items-center gap-4 text-left">
                                    <div class="w-10 h-10 bg-white rounded-xl flex items-center justify-center text-slate-400 group-hover:text-indigo-500 shadow-sm border border-slate-100"><i data-lucide="box" size="20"></i></div>
                                    <div>
                                        <p class="font-bold text-sm text-slate-700 group-hover:text-indigo-800">${r.name}</p>
                                        <p class="text-[9px] text-slate-400 uppercase font-bold tracking-wider">เลือกดูรายละเอียด</p>
                                    </div>
                                </button>
                            `).join('')}
                        </div>
                    </div>
                </div>
            `;
        }

        function renderHistoryModal() {
            if (!window.state.showHistoryModal) return "";
            
            const myBookings = window.state.bookings
                .filter(b => b.studentId === window.state.studentId)
                .sort((a, b) => (b.createdAt?.seconds || 0) - (a.createdAt?.seconds || 0));
            const dateSummary = {};
            myBookings.forEach(b => {
                 dateSummary[b.date] = (dateSummary[b.date] || 0) + 1;
            });
            const sortedSummaryDates = Object.keys(dateSummary).sort();

            return `
                <div class="fixed inset-0 bg-slate-900/80 backdrop-blur-sm z-[9999] flex items-center justify-center p-8 page-transition">
                    <!-- ปรับแก้: ขยายความกว้าง Modal เล็กน้อยเป็น max-w-md -->
                    <div class="bg-white rounded-[2.5rem] p-8 max-w-md w-full text-center shadow-2xl border border-white relative">
                        <button onclick="window.closeHistoryModal()" class="absolute -top-3 -right-3 w-10 h-10 bg-white text-slate-800 rounded-full shadow-lg flex items-center justify-center border border-slate-100 active:scale-90 transition-transform"><i data-lucide="x" size="20"></i></button>
                        
                        <div class="w-14 h-14 bg-indigo-50 text-indigo-600 rounded-2xl flex items-center justify-center mx-auto mb-4 shadow-sm">
                            <i data-lucide="calendar-check" size="28"></i>
                        </div>
                        <h3 class="text-lg font-black text-slate-800 mb-1 leading-tight">รายการวันที่จอง</h3>
                        <p class="text-[10px] text-slate-400 font-bold uppercase tracking-widest mb-6">เลือกวันที่เพื่อดูรายละเอียด</p>
                        
                        <div class="space-y-2 max-h-[50vh] overflow-y-auto custom-scrollbar pr-1">
                            ${sortedSummaryDates.length === 0 ? 
                                '<p class="text-xs text-slate-400 py-4">ยังไม่มีรายการจอง</p>' : 
                                sortedSummaryDates.map(d => `
                                    <button onclick="window.goToDate('${d}')" class="w-full flex justify-between items-center p-4 bg-slate-50 border border-slate-100 rounded-2xl hover:bg-indigo-50 hover:border-indigo-100 hover:text-indigo-700 transition-all active:scale-[0.98] group">
                                        <div class="flex items-center gap-3">
                                            <i data-lucide="calendar" size="16" class="text-slate-300 group-hover:text-indigo-400"></i>
                                            <span class="text-sm font-bold text-slate-700 group-hover:text-indigo-700">${formatDateTH(d)}</span>
                                        </div>
                                        <span class="bg-white px-2 py-1 rounded-lg text-[10px] font-black text-slate-400 shadow-sm border border-slate-100 group-hover:text-indigo-500">${dateSummary[d]} ชม.</span>
                                    </button>
                                `).join('')
                            }
                        </div>
                    </div>
                </div>
            `;
        }

        function renderUIModal() {
            if (!window.state.modal.show) return "";
            const isConfirm = window.state.modal.type === 'confirm';
            return `
                <div class="fixed inset-0 bg-slate-900/80 backdrop-blur-sm z-[9999] flex items-center justify-center p-8 page-transition">
                    <div class="bg-white rounded-[2.5rem] p-10 max-w-sm w-full text-center shadow-2xl border border-white">
                        <div class="w-16 h-16 ${window.state.modal.type === 'error' ? 'bg-red-50 text-red-500' : window.state.modal.type === 'success' ? 'bg-green-50 text-green-500' : 'bg-indigo-50 text-indigo-600'} rounded-3xl flex items-center justify-center mx-auto mb-6 shadow-inner text-center">
                            <i data-lucide="${window.state.modal.type === 'error' ? 'alert-octagon' : window.state.modal.type === 'success' ? 'check-circle' : isConfirm ? 'help-circle' : 'info'}" size="32"></i>
                        </div>
                        <h3 class="text-xl font-black text-slate-800 mb-2 leading-tight">${window.state.modal.title}</h3>
                        <p class="text-sm text-slate-500 font-medium leading-relaxed whitespace-pre-line">${window.state.modal.message}</p>
                        <div class="mt-8 flex gap-3 text-center">
                            ${isConfirm ? `
                                <button onclick="window.closeModal()" class="flex-1 py-4 bg-slate-100 text-slate-500 font-bold rounded-2xl text-center">ยกเลิก</button>
                                <button onclick="window.state.modal.onConfirm(); window.closeModal();" class="flex-1 py-4 bg-indigo-600 text-white font-bold rounded-2xl shadow-lg border-b-4 border-indigo-900 text-center">ยืนยัน</button>
                            ` : `
                                <button onclick="window.closeModal()" class="w-full py-4 bg-slate-900 text-white font-bold rounded-2xl shadow-lg text-center">รับทราบ</button>
                            `}
                        </div>
                    </div>
                </div>
            `;
        }

        init();

        window.setView = setView;
        window.handleLogin = handleLogin;
        window.logout = logout;
        window.selectResource = selectResource;
        window.toggleSlotSelection = toggleSlotSelection;
        window.confirmBookingAction = confirmBookingAction;
        window.saveSettings = saveSettings;
        window.saveWhitelist = saveWhitelist;
        window.addRes = addRes;
        window.deleteResource = deleteResource;
        window.delBooking = delBooking;
        window.clearByDay = clearByDay;
        window.clearAllHistory = clearAllHistory;
        window.openQRModal = openQRModal;
        // FIXED: Added restore scroll flag to prevent jumping to top
        window.closeQRModal = () => { window.state.shouldRestoreScroll = true; window.state.showQRModal = null; window.render(); };
        window.closeModal = closeModal;
        window.requestCameraPermission = requestCameraPermission;
        window.render = render;
        window.toggleHistoryItem = toggleHistoryItem;
        window.clearMyHistory = clearMyHistory;
        window.moveResource = moveResource;
        window.viewPassToday = viewPassToday;
        window.scrollToTarget = scrollToTarget;
        window.formatDateShortTH = formatDateShortTH;
        window.goToDate = goToDate;
        window.toggleSystemStatus = toggleSystemStatus;
        window.addClosedDate = addClosedDate;
        window.removeClosedDate = removeClosedDate;
        window.openHistoryModal = openHistoryModal;
        // FIXED: Added restore scroll flag
        window.closeHistoryModal = () => { window.state.shouldRestoreScroll = true; window.state.showHistoryModal = false; window.render(); };
        
        // New exports for edit functionality
        window.openEditResourceModal = openEditResourceModal;
        window.closeEditResourceModal = closeEditResourceModal;
        window.saveEditResource = saveEditResource;
        
        // New exports for announcement functionality
        window.saveAnnouncement = saveAnnouncement;
        window.selectResourceFromDate = selectResourceFromDate;
        
        // EXPORT NEW FUNCTION
        window.goHome = goHome;
        window.openStudentDetail = openStudentDetail;
        window.closeStudentDetail = closeStudentDetail;
    </script>
</body>
</html>
